<!DOCTYPE html>
<html lang="en"><!-- equinox-calculator-v5.0 old:v4.7 -->
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Blazer EV ‚Äî Efficiency Calculator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;600;700;800&display=swap');

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;min-height:100%;background:#030712;font-family:'Outfit',ui-sans-serif,system-ui,sans-serif;color:#f1f5f9}
:root{
  --green:#90EE90;
  --green-dim:rgba(144,238,144,0.15);
  --blue:#3b82f6;
  --slate:#1e293b;
  --slate2:#0f172a;
  --slate3:#334155;
  --text-muted:#64748b;
  --text-sub:#475569;
  --mono:'DM Mono',ui-monospace,monospace;
}
#app{max-width:1400px;margin:0 auto;padding:12px 14px}

/* ‚îÄ‚îÄ scrollbar ‚îÄ‚îÄ */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-thumb{background:#334155;border-radius:3px}

/* ‚îÄ‚îÄ inputs ‚îÄ‚îÄ */
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:5px;border-radius:9999px;outline:none;cursor:pointer;display:block}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#fff;border:2px solid #1e293b;box-shadow:0 1px 4px rgba(0,0,0,.6);cursor:pointer;transition:transform .1s}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2)}
input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#fff;border:2px solid #1e293b;cursor:pointer}

/* ‚îÄ‚îÄ cards ‚îÄ‚îÄ */
.card{background:var(--slate2);border:1px solid var(--slate);border-radius:12px;padding:14px;margin-bottom:10px}
.mini{background:var(--slate);border-radius:7px;padding:8px;margin-bottom:6px}
.mono{font-family:var(--mono)}

/* ‚îÄ‚îÄ buttons ‚îÄ‚îÄ */
button{cursor:pointer;border:none;font-family:'Outfit',sans-serif}
.btn{padding:5px 12px;border-radius:5px;font-size:11px;font-weight:600;transition:background .12s}
.bon{background:#2563eb;color:#fff}
.boff{background:var(--slate);color:#94a3b8}
.boff:hover{background:var(--slate3);color:#e2e8f0}

/* ‚îÄ‚îÄ top bar ‚îÄ‚îÄ */
.topbar{display:flex;align-items:center;gap:8px;background:var(--slate2);border:1px solid var(--slate);border-radius:10px;padding:9px 13px;margin-bottom:9px;flex-wrap:wrap}
.sep{width:1px;height:26px;background:var(--slate);flex-shrink:0}
.dt-btn{padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;transition:background .15s,color .15s}
.dt-fwd{background:#2563eb;color:#fff}
.dt-awd{background:#7c3aed;color:#fff}
.dt-off{background:var(--slate);color:#64748b}
.dt-off:hover{background:var(--slate3);color:#94a3b8}
.unit-btn{padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700}

/* ‚îÄ‚îÄ scenario strip ‚îÄ‚îÄ */
.sc-wrap{background:var(--slate2);border:1px solid var(--slate);border-radius:12px;padding:12px 14px;margin-bottom:9px}
.sc-title{font-size:10px;color:var(--green);font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px}
.sc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:0}
.sc-btn{
  background:var(--slate);border-radius:9px;padding:9px 8px;text-align:left;
  border:1.5px solid transparent;transition:border-color .2s,background .2s,transform .1s;
  cursor:pointer;position:relative;overflow:hidden;
}
.sc-btn:hover{background:#1a2744;transform:translateY(-1px)}
.sc-btn.active{background:#0f2040;border-color:#3b82f6;box-shadow:0 0 12px rgba(59,130,246,0.2)}
.sc-btn.active::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#3b82f6,#90EE90)}
.sc-icon{font-size:18px;margin-bottom:4px;display:block}
.sc-name{font-size:11px;font-weight:700;color:#e2e8f0;display:block;line-height:1.2;margin-bottom:3px}
.sc-sub{font-size:9px;color:var(--green);line-height:1.4;display:block}
.sc-badge{position:absolute;top:7px;right:7px;font-size:8px;font-weight:700;padding:2px 5px;border-radius:3px;background:#166534;color:#86efac}
.sc-badge.warm{background:#78350f;color:#fcd34d}
.sc-badge.base{background:#1e3a5f;color:#93c5fd}

/* ‚îÄ‚îÄ temp slider panel (always visible) ‚îÄ‚îÄ */
.temp-panel{background:var(--slate2);border:1px solid var(--slate);border-radius:12px;padding:12px 14px;margin-bottom:9px}
.temp-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.temp-label{font-size:11px;color:#94a3b8;font-weight:700;text-transform:uppercase;letter-spacing:.05em}
.temp-value{font-family:var(--mono);font-size:24px;font-weight:500;color:#60a5fa;transition:color .3s}
.temp-ticks{display:flex;justify-content:space-between;margin-top:5px}
.temp-tick{font-size:8px;font-family:var(--mono);text-align:center;flex:1;min-width:0;transition:color .3s,font-weight .3s}

/* ‚îÄ‚îÄ chart card ‚îÄ‚îÄ */
.chart-card{background:var(--slate2);border:1px solid var(--slate);border-radius:12px;padding:14px;margin-bottom:9px}
.chart-meta{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.chart-title{font-size:13px;font-weight:700;color:#e2e8f0}
.chart-hint{font-size:10px;color:var(--text-sub);margin-top:2px}
.chart-conditions{font-size:9px;color:var(--text-sub);text-align:right;line-height:1.9}
.cwrap{position:relative;width:100%}
canvas{display:block;border-radius:8px}
.tip{position:absolute;background:#020617;border:1px solid #334155;border-radius:8px;padding:9px 13px;pointer-events:none;display:none;font-size:11px;min-width:190px;z-index:10;line-height:1.9;box-shadow:0 4px 20px rgba(0,0,0,.5)}

/* ‚îÄ‚îÄ delta strip ‚îÄ‚îÄ */
.delta-strip{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:8px}
.dbox{background:var(--slate);border-radius:8px;padding:8px 6px;text-align:center;border:1px solid transparent;transition:border-color .3s}
.dbox-spd{font-size:9px;color:#64748b;font-weight:700;margin-bottom:3px}
.dbox-eff{font-size:15px;font-weight:700;font-family:var(--mono)}
.dbox-range{font-size:9px;color:#94a3b8;margin-top:1px;font-family:var(--mono)}
.dbox-delta{font-size:9px;font-family:var(--mono);margin-top:2px;font-weight:600}
.dbox-mi{font-size:9px;color:var(--text-sub);margin-top:1px}

/* ‚îÄ‚îÄ advanced panel ‚îÄ‚îÄ */
.adv-wrap{background:var(--slate2);border:1px solid var(--slate);border-radius:12px;margin-bottom:9px;overflow:hidden}
.adv-toggle{width:100%;display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:transparent;font-family:'Outfit',sans-serif;cursor:pointer;transition:background .15s}
.adv-toggle:hover{background:rgba(255,255,255,.03)}
.adv-toggle-left{display:flex;align-items:center;gap:10px}
.adv-toggle-icon{font-size:14px}
.adv-toggle-text{font-size:12px;font-weight:700;color:#94a3b8}
.adv-toggle-sub{font-size:10px;color:var(--text-muted);margin-top:1px}
.adv-chevron{font-size:14px;color:var(--text-muted);transition:transform .3s}
.adv-chevron.open{transform:rotate(180deg)}
.adv-body{max-height:0;overflow:hidden;transition:max-height .45s cubic-bezier(.4,0,.2,1)}
.adv-body.open{max-height:1200px}
.adv-inner{padding:0 14px 14px}
.sgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}

/* ‚îÄ‚îÄ slider / toggle components ‚îÄ‚îÄ */
.sec{background:var(--slate2);border:1px solid var(--slate);border-radius:9px;padding:10px}
.slbl{font-size:9px;color:var(--text-muted);font-weight:700;text-transform:uppercase;letter-spacing:.06em;display:flex;align-items:center;gap:4px;margin-bottom:7px}
.dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.sbox{margin-bottom:5px}
.shdr{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:3px}
.tw{display:flex;align-items:center;justify-content:space-between;gap:6px;background:var(--slate);border-radius:6px;padding:7px 9px;margin-bottom:5px}
.ttrack{position:relative;width:38px;height:21px;border-radius:9999px;flex-shrink:0;border:none;transition:background .15s;cursor:pointer}
.tthumb{position:absolute;top:3px;width:15px;height:15px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.4);transition:left .15s;pointer-events:none}
.barbg{height:11px;background:var(--slate2);border-radius:9999px;overflow:hidden;margin:2px 0}
.barfill{height:100%;border-radius:9999px;transition:width .2s}

/* ‚îÄ‚îÄ quick boxes ‚îÄ‚îÄ */
.qgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:9px}
.qbox{background:var(--slate);border-radius:7px;padding:10px;text-align:center}

/* ‚îÄ‚îÄ table ‚îÄ‚îÄ */
table{width:100%;border-collapse:collapse}
th,td{padding:6px 10px;font-size:11px}
th{color:#94a3b8;font-weight:600;border-bottom:1px solid var(--slate);text-align:center}
th:first-child,td:first-child{text-align:left}
td{border-bottom:1px solid var(--slate2);text-align:center}

/* ‚îÄ‚îÄ breakdown ‚îÄ‚îÄ */
.agrid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:8px}
.sum-strip{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;padding:12px;margin-bottom:12px}
pre{font-size:10px;line-height:1.6;white-space:pre-wrap;background:#020617;border-radius:7px;padding:12px;color:#86efac;margin-top:8px;font-family:var(--mono)}

/* ‚îÄ‚îÄ custom badge ‚îÄ‚îÄ */
.custom-pill{display:inline-block;background:#1a1a2e;border:1px solid #3b82f6;color:#93c5fd;font-size:9px;font-weight:700;padding:2px 7px;border-radius:9999px;margin-left:8px;vertical-align:middle;animation:pulse-in .3s ease-out}
@keyframes pulse-in{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}

/* ‚îÄ‚îÄ responsive ‚îÄ‚îÄ */
@media(max-width:1100px){.sgrid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:900px){.sc-grid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:700px){.sgrid{grid-template-columns:repeat(2,1fr)}.sc-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:500px){.sgrid{grid-template-columns:1fr 1fr}.qgrid{grid-template-columns:1fr 1fr}.agrid{grid-template-columns:1fr 1fr 1fr}.sc-grid{grid-template-columns:1fr 1fr}.delta-strip{grid-template-columns:repeat(5,1fr)}}
</style>
</head>
<body>
<div id="app"></div>
<script>
'use strict';

// ‚îÄ‚îÄ Read URL params from landing page ‚îÄ‚îÄ
(function readURLParams(){
  try{
    var p=new URLSearchParams(window.location.search);
    if(p.get('metric')!==null){
      var m=p.get('metric')==='1';
      try{localStorage.setItem('equinox_metric',m?'1':'0');}catch(e){}
    }
    if(p.get('scenario')){
      var sc=p.get('scenario');
      // will be applied after SCENARIOS is defined
      window.__LANDING_SCENARIO__=sc;
    }
  }catch(e){}
})();

// ================================================================
// PHYSICS ENGINE
// ================================================================
// Blazer EV ‚Äî EPA back-calibrated physics
// FWD: 2162kg (4768lb) est. | AWD: 2341kg (5163lb) Edmunds verified
// Cd=0.31 estimated (not officially published by GM) | A=2.748m¬≤
var CFG={
  fwd:{label:"FWD Single Motor",eta:0.878,massAdd:0,  pack:85,epa_mi:312,mpge:104,awd:false},
  awd:{label:"AWD Dual Motor",  eta:0.812,massAdd:179,pack:85,epa_mi:283,mpge:94, awd:true}
};
var BM=2162,BCD=0.31,BA=2.748,BCR=0.009,GG=9.81,PACC=400,UA=165,AWD_CRR=0.0005;

function rho(f,alt_ft){
  alt_ft=alt_ft||0;
  var rsl=1.2929*273.15/((f-32)*5/9+273.15);
  var pr=Math.pow(1-2.2558e-5*alt_ft*0.3048,5.2559);
  return rsl*pr;
}
function hpCOP(f){
  // Smooth linear interpolation between measured COP points
  // 0¬∞F=1.0, 20¬∞F=1.55, 30¬∞F=2.0, 45¬∞F=2.5, 60¬∞F+=3.0
  if(f>=60)return 3.0;
  if(f>=45)return 2.5+(f-45)*(0.5/15);
  if(f>=30)return 2.0+(f-30)*(0.5/15);
  if(f>=20)return 1.55+(f-20)*(0.45/10);
  if(f>=0) return 1.0 +(f-0) *(0.55/20);
  return 1.0;
}
function acCOP(f){return f<=85?3:2.5;}
function bEta(f,soh){
  // Base thermal efficiency by temperature
  var base;
  if(f>=60)base=1.000;
  else if(f>=40)base=0.975;
  else if(f>=20)base=0.945;
  else if(f>=5) base=0.905;
  else           base=0.875;
  // SOH penalty: degraded cells have higher internal resistance
  // 100% SOH = no penalty; 80% SOH = ~2% extra loss
  var sohPenalty=(soh!==undefined)?(100-soh)*0.001:0;
  return Math.max(0.82, base-sohPenalty);
}
function eCrr(p,aw,mass){
  // Base Crr from PSI (lower pressure = more deformation = more resistance)
  var base=Math.max(0.007,BCR+(36-p)*0.00015);
  // AWD bearing drag
  if(aw)base+=AWD_CRR;
  // Load-dependent deformation: tires flatten more under heavier load
  // +0.00004 per 100kg over base vehicle mass (2041kg)
  if(mass&&mass>BM)base+=0.00004*((mass-BM)/100);
  return base;
}

var TRAFFIC_MODES={
  cruise:{label:"Steady Cruise",avgSpeedFrac:1.00,uaFrac:1.00,copPenalty:0.00},
  mixed: {label:"Mixed Flow",   avgSpeedFrac:0.72,uaFrac:0.90,copPenalty:0.05},
  stopgo:{label:"Stop-and-Go", avgSpeedFrac:0.38,uaFrac:0.75,copPenalty:0.12}
};
var SOLAR_LOADS={none:0,partial:220,full:500};

function calcI(mph,af,dk,cf,seat,whl,defrost,wind,pax,cargo,roof,psi,grade,traffic,solar,alt,soh){
  traffic=traffic||"cruise"; solar=solar||"none";
  var cfg=CFG[dk];
  var mass=BM+cfg.massAdd+pax*82+cargo*0.4536;
  var Cd=roof?BCD+0.10:BCD, Av=roof?BA+0.25:BA;
  var Crr=eCrr(psi,cfg.awd,mass);
  var vg=mph*0.44704, va=Math.max(0,(mph+wind)*0.44704);
  alt=alt||0; soh=soh||100;
  var Pa=0.5*rho(af,alt)*Cd*Av*va*va*va;
  var Pr=Crr*mass*GG*vg;
  var Pg=mass*GG*Math.sin(Math.atan(grade/100))*vg;
  var Pt=(Pa+Pr+Pg)/cfg.eta;
  var tm=TRAFFIC_MODES[traffic];
  var avgMph=mph*tm.avgSpeedFrac;
  var effUA=UA*tm.uaFrac;
  var solarW=SOLAR_LOADS[solar];
  var occupantW=100*pax;
  var dT=cf-af;
  var Ph_raw=0;
  if(dT>2) Ph_raw=effUA*dT/hpCOP(af);
  else if(dT<-2){var eCOP=acCOP(af)*(1-tm.copPenalty);Ph_raw=(effUA*Math.abs(dT)+solarW+occupantW)*0.55/eCOP;}
  var Ph=avgMph>0?Ph_raw*(mph/avgMph):Ph_raw;
  var Ps=seat?140:0,Pw=whl?25:0,Pd=defrost?250:0,be=bEta(af,soh);
  var Pb=(Pt+Ph+Ps+Pw+Pd+PACC)/be;
  var usablePack=cfg.pack*(soh/100);
  return{Pa:Pa,Pr:Pr,Pg:Pg,Pt:Pt,Ph:Ph,Ph_raw:Ph_raw,Ps:Ps,Pw:Pw,Pd:Pd,Pb:Pb,be:be,
    Cd:Cd,Crr:Crr,mass:mass,avgMph:avgMph,solarW:solarW,occupantW:occupantW,
    usablePack:usablePack,eff:vg>0?Math.max(0,mph/(Pb/1000)):0};
}

var SPEEDS=[40,50,60,70,80];
var TEMPS_F=[0,20,40,60,80,100];
var TCLR=["#60a5fa","#34d399","#a78bfa","#fbbf24","#f87171","#fb923c"];

// ================================================================
// SCENARIOS
// ================================================================
var BASE_CASE={
  ambientT:70,cabinT:72,wind:0,grade:0,
  seat:false,whl:false,defrost:false,pax:1,cargo:0,roof:false,psi:42,
  traffic:"cruise",solar:"none",alt:0,soh:100
};

var SCENARIOS=[
  {
    key:"jan_commute",
    icon:"ü•∂",name:"January Commute",
    sub:"10¬∞F ¬∑ heaters on ¬∑ stop-and-go",
    badge:"WINTER",badgeClass:"",
    params:{ambientT:10,cabinT:72,wind:5,grade:0,seat:true,whl:true,defrost:true,
            pax:1,cargo:0,roof:false,psi:40,traffic:"stopgo",solar:"none",alt:0,soh:100}
  },
  {
    key:"aug_errand",
    icon:"‚òÄÔ∏è",name:"August Errand Run",
    sub:"95¬∞F ¬∑ A/C on ¬∑ full sun ¬∑ mixed traffic",
    badge:"SUMMER",badgeClass:"warm",
    params:{ambientT:95,cabinT:72,wind:0,grade:0,seat:false,whl:false,defrost:false,
            pax:1,cargo:0,roof:false,psi:42,traffic:"mixed",solar:"full",alt:0,soh:100}
  },
  {
    key:"city_commute",
    icon:"üèôÔ∏è",name:"City Commute",
    sub:"45¬∞F ¬∑ stop-and-go ¬∑ seat heat on",
    badge:"AUTUMN",badgeClass:"",
    params:{ambientT:45,cabinT:72,wind:0,grade:0,seat:true,whl:false,defrost:false,
            pax:1,cargo:0,roof:false,psi:42,traffic:"stopgo",solar:"none",alt:0,soh:100}
  },
  {
    key:"road_trip",
    icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶",name:"Family Road Trip",
    sub:"70¬∞F ¬∑ 4 people ¬∑ luggage ¬∑ headwind",
    badge:"HIGHWAY",badgeClass:"base",
    params:{ambientT:70,cabinT:72,wind:10,grade:0,seat:false,whl:false,defrost:false,
            pax:4,cargo:400,roof:false,psi:42,traffic:"cruise",solar:"none",alt:0,soh:100}
  },
  {
    key:"windy_hwy",
    icon:"üå¨Ô∏è",name:"Windy Highway",
    sub:"70¬∞F ¬∑ 20mph headwind ¬∑ solo",
    badge:"WIND",badgeClass:"base",
    params:{ambientT:70,cabinT:72,wind:20,grade:0,seat:false,whl:false,defrost:false,
            pax:1,cargo:0,roof:false,psi:42,traffic:"cruise",solar:"none",alt:0,soh:100}
  },
  {
    key:"mountain",
    icon:"‚õ∞Ô∏è",name:"Mountain Drive",
    sub:"60¬∞F ¬∑ 4% uphill grade ¬∑ solo",
    badge:"GRADE",badgeClass:"base",
    params:{ambientT:60,cabinT:72,wind:0,grade:4,seat:false,whl:false,defrost:false,
            pax:1,cargo:0,roof:false,psi:42,traffic:"cruise",solar:"none",alt:2000,soh:100}
  },
  {
    key:"best_case",
    icon:"üí®",name:"Best Case Boost",
    sub:"65¬∞F ¬∑ 15mph tailwind ¬∑ solo",
    badge:"BONUS",badgeClass:"warm",
    params:{ambientT:65,cabinT:72,wind:-15,grade:0,seat:false,whl:false,defrost:false,
            pax:1,cargo:0,roof:false,psi:44,traffic:"cruise",solar:"none",alt:0,soh:100}
  },
  {
    key:"perfect",
    icon:"üå§Ô∏è",name:"Perfect Day",
    sub:"70¬∞F ¬∑ calm ¬∑ solo ¬∑ ideal conditions",
    badge:"BASE",badgeClass:"base",
    params:{ambientT:70,cabinT:72,wind:0,grade:0,seat:false,whl:false,defrost:false,
            pax:1,cargo:0,roof:false,psi:42,traffic:"cruise",solar:"none",alt:0,soh:100}
  }
];

// ================================================================
// UNIT HELPERS
// ================================================================
function fToC(f){return(f-32)*5/9;}
function cToF(c){return c*9/5+32;}
function mToK(m){return m*1.60934;}
function kToM(k){return k/1.60934;}
function dTemp(f){return ST.metric?Math.round(fToC(f))+"\u00b0C":f+"\u00b0F";}
function dSpeed(mph){return ST.metric?Math.round(mToK(mph))+" km/h":mph+" mph";}
function dUnit(){return ST.metric?"km/kWh":"mi/kWh";}
function dEff(v){return ST.metric?(v*1.60934).toFixed(2):v.toFixed(2);}
function dEffL(v){return ST.metric?(v*1.60934).toFixed(3):v.toFixed(3);}
function dRange(mi){return ST.metric?Math.round(mToK(mi))+" km":mi+" mi";}
function dMass(kg){return ST.metric?kg+" kg":Math.round(kg*2.205)+" lb";}
function dWind(mph){
  if(mph===0)return"Calm";
  return ST.metric?(mph>0?"+":"")+Math.round(mToK(mph))+" km/h":(mph>0?"+"+mph+" mph headwind":Math.abs(mph)+" mph tailwind");
}
function dGrade(g){return g===0?"Level":g>0?"+"+g+"% uphill":g+"% downhill";}
function epaEff(dk){var c=CFG[dk];var b=c.mpge/33.705;return ST.metric?b*1.60934:b;}

// ================================================================
// STATE
// ================================================================

// Geo defaults injected by Netlify edge function
// Falls back gracefully if running locally or edge function absent
var GEO=window.__GEO__||{country:"US",defaultMetric:false,season:"winter",defaultScenario:"jan_commute"};

// Unit preference: localStorage beats geo beats default
// If user has ever manually set a preference we respect it forever
var storedMetric=null;
try{
  var ls=localStorage.getItem('equinox_metric');
  if(ls!==null)storedMetric=ls==='1';
}catch(e){}
var initialMetric=storedMetric!==null?storedMetric:GEO.defaultMetric;

var ST=Object.assign({
  metric:initialMetric,
  dt:"fwd",view:"chart",selSpd:70,
  activeScenario:GEO.defaultScenario,
  isCustom:false,
  advOpen:false
},BASE_CASE);

function c6(mph,tF,dk){
  return calcI(mph,tF||ST.ambientT,dk||ST.dt,ST.cabinT,ST.seat,ST.whl,ST.defrost,
               ST.wind,ST.pax,ST.cargo,ST.roof,ST.psi,ST.grade,ST.traffic,ST.solar,ST.alt,ST.soh);
}

function getBaseEffs(){
  return SPEEDS.map(function(mph){
    var r=calcI(mph,BASE_CASE.ambientT,ST.dt,BASE_CASE.cabinT,
               BASE_CASE.seat,BASE_CASE.whl,BASE_CASE.defrost,
               BASE_CASE.wind,BASE_CASE.pax,BASE_CASE.cargo,BASE_CASE.roof,
               BASE_CASE.psi,BASE_CASE.grade,BASE_CASE.traffic,BASE_CASE.solar,
               BASE_CASE.alt,BASE_CASE.soh);
    return ST.metric?+(r.eff*1.60934).toFixed(3):+r.eff.toFixed(3);
  });
}

// ================================================================
// PERMALINK
// ================================================================
var PKEYS=['metric','dt','ambientT','cabinT','wind','grade','seat','whl','defrost',
           'pax','cargo','roof','psi','traffic','solar','alt','soh','view','selSpd',
           'activeScenario','advOpen'];

function encodeState(){
  try{
    var p=PKEYS.map(function(k){
      var v=ST[k];
      return k+'='+(typeof v==='boolean'?(v?1:0):encodeURIComponent(v));
    });
    return'#'+p.join('&');
  }catch(e){return'';}
}
function decodeState(hash){
  if(!hash||hash.length<2)return;
  hash.slice(1).split('&').forEach(function(pair){
    var eq=pair.indexOf('=');if(eq<0)return;
    var k=pair.slice(0,eq),v=decodeURIComponent(pair.slice(eq+1));
    if(!(k in ST))return;
    if(typeof ST[k]==='boolean')ST[k]=v==='1';
    else if(typeof ST[k]==='number')ST[k]=+v;
    else ST[k]=v;
  });
}
function copyPermalink(){
  var url='';
  try{url=window.location.href.split('#')[0]+encodeState();}catch(e){url=encodeState();}
  var btn=$id('copy-btn');
  function flash(){if(btn){btn.textContent='‚úì Copied!';btn.style.background='#166534';setTimeout(function(){btn.textContent='Share Link';btn.style.background='';},2000);}}
  if(navigator.clipboard&&navigator.clipboard.writeText){
    navigator.clipboard.writeText(url).then(flash).catch(function(){fallbackCopy(url);flash();});
  }else{fallbackCopy(url);flash();}
}
function fallbackCopy(url){
  var ta=document.createElement('textarea');ta.value=url;ta.style.cssText='position:fixed;opacity:0';
  document.body.appendChild(ta);ta.select();try{document.execCommand('copy');}catch(e){}
  document.body.removeChild(ta);
}
try{if(window.location&&window.location.hash)decodeState(window.location.hash);}catch(e){}
// ================================================================
// GEO DEFAULTS (from Netlify edge function)
// ================================================================
(function applyGeoDefaults(){
  try{
    if(window.__GEO__&&!(window.location&&window.location.hash&&window.location.hash.length>1)){
      ST.metric=!!window.__GEO__.defaultMetric;
      if(window.__GEO__.defaultScenario){
        ST.activeScenario=window.__GEO__.defaultScenario;
        var sc=typeof SCENARIOS!=='undefined'&&SCENARIOS.filter(function(s){return s.key===window.__GEO__.defaultScenario;})[0];
        if(sc)Object.assign(ST,sc.params);
      }
    }
  }catch(e){}
})();


// ================================================================
// DOM HELPERS
// ================================================================
function el(tag,attrs,ch){
  var d=document.createElement(tag);
  if(attrs)Object.keys(attrs).forEach(function(k){
    if(k==='style'&&typeof attrs[k]==='object')Object.assign(d.style,attrs[k]);
    else if(k==='class')d.className=attrs[k];
    else d[k]=attrs[k];
  });
  if(ch){
    if(!Array.isArray(ch))ch=[ch];
    ch.forEach(function(c){
      if(c!=null&&c!==false){
        if(typeof c==='string'||typeof c==='number')d.appendChild(document.createTextNode(String(c)));
        else d.appendChild(c);
      }
    });
  }
  return d;
}
function $id(i){return document.getElementById(i);}

function mkSlider(o){
  var w=el('div',{class:'mini sbox'});
  var h=el('div',{class:'shdr'});
  var lv=el('span',{class:'mono',style:{fontSize:'11px',fontWeight:'700'}});
  function disp(v){return o.fmt?o.fmt(v):v+(o.unit||'');}
  lv.textContent=disp(o.value);
  var lt=o.emoji?o.emoji+' '+o.label:o.label;
  h.appendChild(el('span',{style:{fontSize:'10px',color:'#90EE90',fontWeight:'600'}},lt));
  h.appendChild(lv);w.appendChild(h);
  if(o.sub)w.appendChild(el('div',{style:{fontSize:'9px',color:'#90EE90',marginBottom:'2px'}},o.sub));
  var inp=el('input',{type:'range',min:o.min,max:o.max,step:o.step||1,value:o.value});
  function upd(v){
    var pct=((v-o.min)/(o.max-o.min))*100;
    var cc=o.color||'#3b82f6';
    inp.style.background='linear-gradient(to right,'+cc+' '+pct+'%,#334155 '+pct+'%)';
    lv.style.color=cc;lv.textContent=disp(v);
  }
  upd(o.value);
  inp.addEventListener('input',function(){var v=+inp.value;upd(v);o.onChange(v);});
  w.appendChild(inp);
  var ends=el('div',{style:{display:'flex',justifyContent:'space-between',fontSize:'9px',color:'#90EE90',marginTop:'1px'}});
  ends.appendChild(el('span',null,o.min+(o.unit||'')));
  ends.appendChild(el('span',null,o.max+(o.unit||'')));
  w.appendChild(ends);
  return w;
}

function mkToggle(o){
  var w=el('div',{class:'tw'});
  var inf=el('div',{style:{flex:'1',minWidth:'0'}});
  var lt=o.emoji?o.emoji+' '+o.label:o.label;
  inf.appendChild(el('div',{style:{fontSize:'10px',color:'#cbd5e1',fontWeight:'600'}},lt));
  inf.appendChild(el('div',{style:{fontSize:'9px',color:'#90EE90',marginTop:'1px'}},o.sub));
  var we=el('div',{class:'mono',style:{fontSize:'9px',color:'#f97316',marginTop:'1px',display:'none'}},o.watts+'W');
  inf.appendChild(we);
  var tr=el('button',{class:'ttrack'});
  var th2=el('div',{class:'tthumb'});tr.appendChild(th2);
  var on=o.value||false;
  function set(v){on=v;tr.style.background=v?'#2563eb':'#334155';th2.style.left=v?'20px':'3px';we.style.display=(v&&o.watts>0)?'block':'none';}
  set(on);tr.addEventListener('click',function(){set(!on);o.onChange(on);});
  w.appendChild(inf);w.appendChild(tr);
  return w;
}

function mkLbl(col,txt){
  var d=el('div',{class:'slbl'});
  d.appendChild(el('div',{class:'dot',style:{background:col}}));
  d.appendChild(document.createTextNode(txt));
  return d;
}

// ================================================================
// COLOUR HELPERS
// ================================================================
function barCol(eff,epa){
  var p=(eff-epa)/epa*100;
  if(p>5) return'#22c55e';if(p>0)return'#86efac';
  if(p>-5)return'#facc15';if(p>-15)return'#f97316';return'#ef4444';
}
function effCol(mpk,dk){
  var e=epaEff(dk),v=ST.metric?mpk*1.60934:mpk,p=(v-e)/e*100;
  if(p>5)return'#22c55e';if(p>0)return'#86efac';
  if(p>-5)return'#facc15';if(p>-15)return'#f97316';return'#ef4444';
}
function shd(hex,f){
  var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return'rgb('+Math.min(255,Math.round(r*f))+','+Math.min(255,Math.round(g*f))+','+Math.min(255,Math.round(b*f))+')';
}

// ================================================================
// ANIMATION ENGINE
// ================================================================
var ANIM={
  // current rendered bar heights (in efficiency units)
  curH: SPEEDS.map(function(){return 0;}),
  // target heights
  tgtH: SPEEDS.map(function(){return 0;}),
  // base case heights (ghost ‚Äî static once computed)
  baseH: SPEEDS.map(function(){return 0;}),
  // temp slider animation
  tempCur: BASE_CASE.ambientT,
  tempTgt: BASE_CASE.ambientT,
  // RAF handle
  raf: null,
  // animation start times per bar
  startT: null,
  duration: 520,
  // easing: ease-out cubic
  ease: function(t){return 1-Math.pow(1-t,3);},
  // overshoot spring at end of travel
  spring: function(t){
    if(t<0.85)return this.ease(t/0.85);
    var s=(t-0.85)/0.15;
    // tiny overshoot then settle
    return 1+Math.sin(s*Math.PI)*0.025*(1-s);
  }
};

function animateTo(newEffs, newTemp){
  ANIM.tgtH=newEffs.slice();
  ANIM.tempTgt=newTemp!==undefined?newTemp:ST.ambientT;
  if(ANIM.raf){cancelAnimationFrame(ANIM.raf);ANIM.raf=null;}
  var startH=ANIM.curH.slice();
  var startTemp=ANIM.tempCur;
  var t0=null;

  function frame(ts){
    if(!t0)t0=ts;
    var elapsed=ts-t0;
    var p=Math.min(1,elapsed/ANIM.duration);

    // stagger bars slightly
    for(var i=0;i<SPEEDS.length;i++){
      var delay=i*30; // 30ms stagger between bars
      var lp=Math.min(1,Math.max(0,(elapsed-delay)/(ANIM.duration-delay*SPEEDS.length*0.5)));
      var ep=ANIM.spring(lp);
      ANIM.curH[i]=startH[i]+(ANIM.tgtH[i]-startH[i])*ep;
    }

    // temp slider smooth
    var tp=ANIM.ease(p);
    ANIM.tempCur=startTemp+(ANIM.tempTgt-startTemp)*tp;
    updateTempSliderVisual(ANIM.tempCur);

    drawChart();

    if(p<1){ANIM.raf=requestAnimationFrame(frame);}
    else{
      ANIM.curH=ANIM.tgtH.slice();
      ANIM.tempCur=ANIM.tempTgt;
      updateTempSliderVisual(ANIM.tempCur);
      drawChart();
      ANIM.raf=null;
    }
  }
  ANIM.raf=requestAnimationFrame(frame);
}

// ================================================================
// TEMP SLIDER VISUAL UPDATE (DOM)
// ================================================================
function updateTempSliderVisual(tempF){
  var inp=$id('temp-inp');if(!inp)return;
  inp.value=Math.round(tempF);
  var p=tempF/100;
  var pct=p*100;
  var green=Math.min(pct*0.40/Math.max(p,0.001),pct);
  var yellow=Math.min(pct*0.65/Math.max(p,0.001),pct);
  var grad='linear-gradient(to right,#3b82f6 0%,#34d399 '+green.toFixed(1)+'%,#fbbf24 '+yellow.toFixed(1)+'%,#f87171 '+pct.toFixed(1)+'%,#334155 '+pct.toFixed(1)+'%)';
  inp.style.background=grad;
  var ve=$id('temp-val');if(ve)ve.textContent=dTemp(Math.round(tempF));
  var ticks=document.querySelectorAll('.temp-tick');
  var TICK_TEMPS=[0,10,20,30,40,50,60,70,80,90,100];
  ticks.forEach(function(tk,i){
    var isActive=Math.abs(TICK_TEMPS[i]-Math.round(tempF))<6;
    tk.style.color=isActive?'#60a5fa':'#475569';
    tk.style.fontWeight=isActive?'700':'400';
  });
}

// ================================================================
// CHART DRAW (ghost bar + solid bar)
// ================================================================
var chartCanvas=null,chartTip=null;

function drawChart(){
  var canvas=chartCanvas;if(!canvas)return;
  var W=0;try{W=canvas.parentElement?canvas.parentElement.clientWidth||0:0;}catch(e){}if(!W||W<100)W=700;
  var H=Math.max(240,Math.min(400,Math.round(W*0.42)));
  var dpr=1;try{dpr=window.devicePixelRatio||1;}catch(e){}
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  var ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);

  var PL=54,PR=18,PT=28,PB=48;
  var cw=W-PL-PR,ch=H-PT-PB,n=SPEEDS.length;
  var ANG=22*Math.PI/180,DLEN=18;
  var DX=Math.cos(ANG)*DLEN,DY=-Math.sin(ANG)*DLEN;
  var plotW=cw-DX,slotW=plotW/n,bw=slotW*0.72,gap=(slotW-bw)/2;

  var epa=epaEff(ST.dt);
  // y range covers both current bars and base ghost bars
  var allVals=ANIM.curH.concat(ANIM.baseH).concat([epa]);
  var yMn=Math.max(0,Math.floor(Math.min.apply(null,allVals)*0.88*10)/10);
  var yMx=Math.ceil(Math.max.apply(null,allVals)*1.10*10)/10;
  if(yMx<=yMn)yMx=yMn+0.5;
  var scY=ch/(yMx-yMn);
  var ox=PL,oy=PT+ch;

  function fx(xi,yi){return{x:ox+xi,y:oy-yi};}
  function bk(xi,yi){return{x:ox+xi+DX,y:oy-yi+DY};}

  ctx.fillStyle='#0f172a';ctx.fillRect(0,0,W,H);

  // grid
  var yStep=0.5,ticks=[],ts=Math.ceil((yMn+0.001)/yStep)*yStep;
  for(var tv=ts;tv<=yMx-0.001;tv=Math.round((tv+yStep)*1000)/1000)ticks.push(Math.round(tv*100)/100);
  ctx.strokeStyle='#1e293b';ctx.lineWidth=1;
  ticks.forEach(function(y){
    var yi=(y-yMn)*scY,f1=fx(0,yi),f2=fx(plotW,yi),b2=bk(plotW,yi);
    ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(f1.x,f1.y);ctx.lineTo(f2.x,f2.y);ctx.stroke();
    ctx.beginPath();ctx.moveTo(f2.x,f2.y);ctx.lineTo(b2.x,b2.y);ctx.stroke();
    ctx.setLineDash([]);
  });
  ctx.fillStyle='#94a3b8';ctx.font='10px sans-serif';ctx.textAlign='right';
  ticks.forEach(function(y){var yi=(y-yMn)*scY,p=fx(0,yi);ctx.fillText(y.toFixed(1),p.x-5,p.y+4);});
  ctx.save();ctx.translate(12,PT+ch/2);ctx.rotate(-Math.PI/2);
  ctx.fillStyle='#64748b';ctx.font='10px sans-serif';ctx.textAlign='center';
  ctx.fillText(dUnit(),0,0);ctx.restore();

  // EPA plane
  canvas._epaZone=null;
  if(epa>=yMn&&epa<=yMx){
    var eyi=(epa-yMn)*scY;
    var c1=fx(0,eyi),c2=fx(plotW,eyi),c3=bk(plotW,eyi),c4=bk(0,eyi);
    ctx.save();ctx.globalAlpha=0.10;ctx.fillStyle='#facc15';
    ctx.beginPath();ctx.moveTo(c1.x,c1.y);ctx.lineTo(c2.x,c2.y);ctx.lineTo(c3.x,c3.y);ctx.lineTo(c4.x,c4.y);ctx.closePath();ctx.fill();
    ctx.globalAlpha=0.5;ctx.strokeStyle='#facc15';ctx.lineWidth=1;ctx.setLineDash([5,3]);
    ctx.beginPath();ctx.moveTo(c1.x,c1.y);ctx.lineTo(c2.x,c2.y);ctx.stroke();
    ctx.setLineDash([]);ctx.globalAlpha=1;

    // EPA badge ‚Äî measure text FIRST, then position
    var badgeTxt='EPA '+epa.toFixed(2)+' '+dUnit();
    ctx.font='bold 9px sans-serif';
    var tw=ctx.measureText(badgeTxt).width;
    var badgeW=tw+22,badgeH=18,badgeR=4;
    // Position: right-aligned to end of EPA line, clamped inside canvas
    var bx=Math.min(c2.x-badgeW-4, W-PR-badgeW-4);
    var by=c2.y-badgeH-10;
    ctx.globalAlpha=0.92;ctx.fillStyle='#1a1200';
    ctx.beginPath();
    ctx.moveTo(bx+badgeR,by);ctx.lineTo(bx+badgeW-badgeR,by);
    ctx.arcTo(bx+badgeW,by,bx+badgeW,by+badgeR,badgeR);
    ctx.lineTo(bx+badgeW,by+badgeH-badgeR);
    ctx.arcTo(bx+badgeW,by+badgeH,bx+badgeW-badgeR,by+badgeH,badgeR);
    ctx.lineTo(bx+badgeR,by+badgeH);
    ctx.arcTo(bx,by+badgeH,bx,by+badgeH-badgeR,badgeR);
    ctx.lineTo(bx,by+badgeR);
    ctx.arcTo(bx,by,bx+badgeR,by,badgeR);
    ctx.closePath();ctx.fill();
    ctx.globalAlpha=0.8;ctx.strokeStyle='#facc15';ctx.lineWidth=1;ctx.stroke();
    ctx.globalAlpha=1;ctx.fillStyle='#facc15';ctx.textAlign='left';
    ctx.fillText(badgeTxt,bx+6,by+12);
    var ix=bx+badgeW-13,iy=by+9;
    ctx.beginPath();ctx.arc(ix,iy,6,0,Math.PI*2);
    ctx.fillStyle='#facc15';ctx.globalAlpha=0.2;ctx.fill();
    ctx.globalAlpha=1;ctx.strokeStyle='#facc15';ctx.lineWidth=1;ctx.stroke();
    ctx.fillStyle='#facc15';ctx.font='bold 8px sans-serif';ctx.textAlign='center';
    ctx.fillText('?',ix,iy+3);
    ctx.restore();
    canvas._epaZone={x:bx,y:by,w:badgeW,h:badgeH,epa:epa};
  }

  canvas._zones=[];

  for(var i=0;i<n;i++){
    var curEff=ANIM.curH[i];
    var baseEff=ANIM.baseH[i];
    var curClamped=Math.max(yMn,Math.min(yMx,curEff));
    var baseClamped=Math.max(yMn,Math.min(yMx,baseEff));
    var curH=(curClamped-yMn)*scY;
    var baseH=(baseClamped-yMn)*scY;
    var col=barCol(curEff,epa);
    var x0=i*slotW+gap,x1=x0+bw,xm=x0+bw/2;
    var isAtBase=Math.abs(curEff-baseEff)<0.005;

    // ‚îÄ‚îÄ GHOST BAR (base case outline) ‚îÄ‚îÄ
    if(!isAtBase&&baseH>2){
      var gs='rgba(160,185,210,0.65)';
      var gf='rgba(100,130,160,0.07)';

      // ghost right face
      var grbl=fx(x1,0),grtl=fx(x1,baseH),grtb=bk(x1,baseH),grbb=bk(x1,0);
      ctx.beginPath();ctx.moveTo(grbl.x,grbl.y);ctx.lineTo(grtl.x,grtl.y);
      ctx.lineTo(grtb.x,grtb.y);ctx.lineTo(grbb.x,grbb.y);ctx.closePath();
      ctx.fillStyle=gf;ctx.fill();ctx.strokeStyle=gs;ctx.lineWidth=1.2;ctx.stroke();

      // ghost top face
      var gtfl=fx(x0,baseH),gtfr=fx(x1,baseH),gtbr=bk(x1,baseH),gtbl=bk(x0,baseH);
      ctx.beginPath();ctx.moveTo(gtfl.x,gtfl.y);ctx.lineTo(gtfr.x,gtfr.y);
      ctx.lineTo(gtbr.x,gtbr.y);ctx.lineTo(gtbl.x,gtbl.y);ctx.closePath();
      ctx.fillStyle='rgba(160,185,210,0.13)';ctx.fill();ctx.strokeStyle=gs;ctx.lineWidth=1.2;ctx.stroke();

      // ghost front face
      var gfbl=fx(x0,0),gftl=fx(x0,baseH),gftr=fx(x1,baseH),gfbr=fx(x1,0);
      ctx.beginPath();ctx.moveTo(gfbl.x,gfbl.y);ctx.lineTo(gftl.x,gftl.y);
      ctx.lineTo(gftr.x,gftr.y);ctx.lineTo(gfbr.x,gfbr.y);ctx.closePath();
      ctx.fillStyle=gf;ctx.fill();ctx.strokeStyle=gs;ctx.lineWidth=1.2;ctx.stroke();

      // penalty fill (only when current < base)
      if(curEff<baseEff&&curH>0){
        var pfbl=fx(x0,curH),pftl=fx(x0,baseH),pftr=fx(x1,baseH),pfbr=fx(x1,curH);
        ctx.beginPath();ctx.moveTo(pfbl.x,pfbl.y);ctx.lineTo(pftl.x,pftl.y);
        ctx.lineTo(pftr.x,pftr.y);ctx.lineTo(pfbr.x,pfbr.y);ctx.closePath();
        ctx.fillStyle='rgba(239,68,68,0.15)';ctx.fill();
        // subtle dashed top edge on penalty zone
        ctx.setLineDash([3,3]);ctx.strokeStyle='rgba(239,68,68,0.35)';ctx.lineWidth=0.8;
        ctx.beginPath();ctx.moveTo(pfbl.x,pfbl.y);ctx.lineTo(pfbr.x,pfbr.y);ctx.stroke();
        ctx.setLineDash([]);
      }

      // ghost base label (floating above ghost top)
      var glp=fx(xm,baseH);
      ctx.fillStyle='rgba(160,185,210,0.75)';ctx.font='9px '+'"DM Mono",ui-monospace,monospace';ctx.textAlign='center';
      ctx.fillText(baseEff.toFixed(2),glp.x,glp.y-(curEff<baseEff?17:6));
    }

    // ‚îÄ‚îÄ SOLID BAR (current) ‚îÄ‚îÄ
    // right face
    var rbl=fx(x1,0),rtl=fx(x1,curH),rtb=bk(x1,curH),rbb=bk(x1,0);
    ctx.beginPath();ctx.moveTo(rbl.x,rbl.y);ctx.lineTo(rtl.x,rtl.y);
    ctx.lineTo(rtb.x,rtb.y);ctx.lineTo(rbb.x,rbb.y);ctx.closePath();
    ctx.fillStyle=shd(col,0.52);ctx.fill();ctx.strokeStyle=shd(col,0.35);ctx.lineWidth=0.5;ctx.stroke();
    // top face
    var tfl=fx(x0,curH),tfr=fx(x1,curH),tbr=bk(x1,curH),tbl2=bk(x0,curH);
    ctx.beginPath();ctx.moveTo(tfl.x,tfl.y);ctx.lineTo(tfr.x,tfr.y);
    ctx.lineTo(tbr.x,tbr.y);ctx.lineTo(tbl2.x,tbl2.y);ctx.closePath();
    ctx.fillStyle=shd(col,1.28);ctx.fill();ctx.strokeStyle=shd(col,0.8);ctx.lineWidth=0.5;ctx.stroke();
    // front face
    var fbl=fx(x0,0),ftl=fx(x0,curH),ftr=fx(x1,curH),fbr=fx(x1,0);
    ctx.beginPath();ctx.moveTo(fbl.x,fbl.y);ctx.lineTo(ftl.x,ftl.y);
    ctx.lineTo(ftr.x,ftr.y);ctx.lineTo(fbr.x,fbr.y);ctx.closePath();
    ctx.fillStyle=col;ctx.fill();ctx.strokeStyle=shd(col,0.6);ctx.lineWidth=0.5;ctx.stroke();

    // value label
    if(curH>12){
      var lp=fx(xm,curH);
      ctx.fillStyle='#f1f5f9';ctx.font='bold 10px "DM Mono",ui-monospace,monospace';ctx.textAlign='center';
      ctx.fillText(curEff.toFixed(2),lp.x,lp.y-6);
    }

    // speed label
    var xp=fx(xm,0);
    ctx.fillStyle='#94a3b8';ctx.font='10px sans-serif';ctx.textAlign='center';
    ctx.fillText(ST.metric?Math.round(mToK(SPEEDS[i])):SPEEDS[i],xp.x,xp.y+16);

    canvas._zones.push({cx:fx(xm,0).x,mph:SPEEDS[i],eff:curEff,baseEff:baseEff,col:col});
  }

  // x axis label
  ctx.fillStyle='#64748b';ctx.font='10px sans-serif';ctx.textAlign='center';
  ctx.fillText(ST.metric?'Speed (km/h)':'Speed (mph)',ox+plotW/2,H-5);

  // legend
  var kits=[
    {c:'#22c55e',l:'>5% above EPA'},{c:'#86efac',l:'0‚Äì5% above EPA'},
    {c:'#facc15',l:'within 5% below'},{c:'#f97316',l:'5‚Äì15% below'},{c:'#ef4444',l:'>15% below EPA'}
  ];
  var kx=PL,ky=13;ctx.font='9px sans-serif';ctx.textAlign='left';
  kits.forEach(function(ki){
    ctx.fillStyle=ki.c;ctx.fillRect(kx,ky-8,9,8);
    ctx.fillStyle='#64748b';ctx.fillText(ki.l,kx+12,ky-1);
    kx+=ctx.measureText(ki.l).width+26;
    if(kx>W-90){kx=PL;ky+=12;}
  });

  updateDeltaStrip();
}

// ================================================================
// DELTA STRIP
// ================================================================
function updateDeltaStrip(){
  var strip=$id('delta-strip');if(!strip)return;
  var epa=epaEff(ST.dt);
  var c=CFG[ST.dt];
  SPEEDS.forEach(function(mph,i){
    var cur=ANIM.curH[i],base=ANIM.baseH[i];
    var delta=cur-base,pct=base>0?(delta/base*100):0;
    var col=barCol(cur,epa);
    var dCol=delta>0.005?'#22c55e':delta<-0.005?'#f87171':'#94a3b8';
    var box=$id('dbox-'+i);if(!box)return;
    box.querySelector('.dbox-eff').textContent=dEff(cur);
    box.querySelector('.dbox-eff').style.color=col;
    var rangeVal=Math.round((ST.metric?cur/1.60934:cur)*(c.pack*(ST.soh/100)));
    box.querySelector('.dbox-range').textContent='üîã ~'+dRange(rangeVal);
    var dEl=box.querySelector('.dbox-delta');
    if(Math.abs(delta)<0.005){
      dEl.textContent='= Base';dEl.style.color='#475569';
    }else{
      var miLoss=Math.round(Math.abs(delta/epa)*c.pack);
      dEl.textContent=(delta>=0?'+':'')+dEff(delta)+' ('+( pct>=0?'+':'')+pct.toFixed(1)+'%)';
      dEl.style.color=dCol;
      var miEl=box.querySelector('.dbox-mi');
      if(miEl){
        if(Math.abs(delta)>0.01){
          miEl.textContent=(delta>=0?'+':'-')+dRange(miLoss)+' range';
          miEl.style.color=dCol;
        }else{miEl.textContent='';}
      }
    }
  });
}

// ================================================================
// SCENARIO ACTIVATION
// ================================================================
function activateScenario(key, animate){
  var sc=SCENARIOS.filter(function(s){return s.key===key;})[0];
  if(!sc)return;
  ST.activeScenario=key;
  ST.isCustom=false;
  track('scenario_click', key);

  // apply params to state
  Object.assign(ST,sc.params);

  // update scenario button active states
  document.querySelectorAll('.sc-btn').forEach(function(b){
    b.classList.toggle('active',b.dataset.key===key);
  });

  // hide custom pill
  var cp=$id('custom-pill');if(cp)cp.style.display='none';

  // recompute targets
  var newEffs=SPEEDS.map(function(mph){
    var r=c6(mph,ST.ambientT,ST.dt);
    return ST.metric?+(r.eff*1.60934).toFixed(3):+r.eff.toFixed(3);
  });

  if(animate!==false){
    animateTo(newEffs,ST.ambientT);
  }else{
    ANIM.curH=newEffs.slice();
    ANIM.tempCur=ST.ambientT;
    updateTempSliderVisual(ST.ambientT);
    drawChart();
  }

  // rebuild advanced panel from current ST if it's open
  if(ST.advOpen){
    var advInner=document.querySelector('.adv-inner');
    if(advInner)buildAdvancedPanel(advInner);
  }
  updateConditionsLine();
}

function markCustom(){
  if(!ST.isCustom){
    ST.isCustom=true;
    ST.activeScenario='';
    document.querySelectorAll('.sc-btn').forEach(function(b){b.classList.remove('active');});
    var cp=$id('custom-pill');if(cp)cp.style.display='inline-block';
  }
}

function recomputeAndAnimate(){
  var newEffs=SPEEDS.map(function(mph){
    var r=c6(mph,ST.ambientT,ST.dt);
    return ST.metric?+(r.eff*1.60934).toFixed(3):+r.eff.toFixed(3);
  });
  animateTo(newEffs,ST.ambientT);
  updateConditionsLine();
  updateQuickBoxes();
  try{if(window.history&&window.history.replaceState)window.history.replaceState(null,'',encodeState());}catch(e){}
}

function updateConditionsLine(){
  var el2=$id('chart-cond');if(!el2)return;
  var tl={cruise:'üõ£Ô∏è Steady Cruise',mixed:'üöô Mixed Flow',stopgo:'üõë Stop-and-Go'};
  var sl={none:'‚òÅÔ∏è No sun',partial:'‚õÖ Partly',full:'‚òÄÔ∏è Full sun'};
  el2.textContent='üå°Ô∏è Cabin '+dTemp(ST.cabinT)+' | üí® '+dWind(ST.wind)+' | ‚õ∞Ô∏è '+dGrade(ST.grade)+' | '+tl[ST.traffic]+' | '+sl[ST.solar];
}

// ================================================================
// ADVANCED PANEL SYNC
// ================================================================
var advSliderRefs={};

function syncAdvancedPanel(){
  // update any slider DOM elements that exist
  Object.keys(advSliderRefs).forEach(function(k){
    var ref=advSliderRefs[k];
    if(ref&&ref.inp&&ref.lv&&ref.upd){
      var raw=ST[k];
      var disp=ref.toDisp?ref.toDisp(raw):raw;
      ref.inp.value=disp;
      ref.upd(disp);
    }
  });
  // toggles
  ['seat','whl','defrost','roof'].forEach(function(k){
    var tr=$id('tog-'+k);if(!tr)return;
    var th=tr.querySelector('.tthumb');
    var on=ST[k];
    tr.style.background=on?'#2563eb':'#334155';
    if(th)th.style.left=on?'20px':'3px';
  });
  var hld=$id('hld');
  if(hld){var w=(ST.seat?140:0)+(ST.whl?25:0)+(ST.defrost?250:0);hld.textContent='üîå Heaters: '+(w>0?w+'W':'none');}
}

// ================================================================
// BUILD APP
// ================================================================
var app=$id('app'),viewBtns={},tabContent,quickBoxes=[];
var fwdBtn,awdBtn,unitBtns={};

function buildApp(){
  // ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ
  var hdr=el('div',{style:{borderBottom:'1px solid #1e293b',paddingBottom:'10px',marginBottom:'9px',
    display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:'8px'}});
  var hl=el('div',{style:{display:'flex',alignItems:'center',gap:'9px'}});
  hl.appendChild(el('a',{href:'index.html',style:{fontSize:'12px',color:'#f97316',textDecoration:'none',fontFamily:"var(--mono)",letterSpacing:'.05em',marginRight:'6px',fontWeight:'700',padding:'5px 12px',background:'#1a0a00',border:'1px solid #f97316',borderRadius:'6px',display:'inline-block'}},'‚Üê Home'));
  hl.appendChild(el('span',{style:{background:'#7c3aed',color:'#fff',padding:'2px 8px',borderRadius:'4px',fontSize:'9px',fontWeight:'800',letterSpacing:'.05em'}},'BZ v1.0'));
  var ti=el('div',null);
  ti.appendChild(el('div',{style:{fontSize:'16px',fontWeight:'800',color:'#fff',letterSpacing:'-.01em'}},'Chevrolet Blazer EV ‚Äî Efficiency Calculator'));
  ti.appendChild(el('div',{style:{fontSize:'10px',color:'#90EE90',marginTop:'2px'}},'Physics-based | 2025‚Äì2026 | FWD & AWD | Imperial & Metric'));
  hl.appendChild(ti);
  var tbr=el('div',{style:{display:'flex',gap:'4px',flexWrap:'wrap',alignItems:'center'}});
  var cpBtn=el('button',{class:'btn boff',style:{fontSize:'10px',padding:'5px 10px'}},'Share Link');
  cpBtn.id='copy-btn';cpBtn.addEventListener('click',copyPermalink);tbr.appendChild(cpBtn);
  tbr.appendChild(el('div',{style:{width:'1px',height:'20px',background:'#1e293b'}}));
  [['chart','Chart'],['breakdown','Breakdown'],['table','Table'],['model','Model']].forEach(function(tb){
    var b=el('button',{class:'btn '+(ST.view===tb[0]?'bon':'boff')},tb[1]);
    b.addEventListener('click',function(){ST.view=tb[0];track('tab_view',tb[0]);setView(tb[0]);});
    viewBtns[tb[0]]=b;tbr.appendChild(b);
  });
  hdr.appendChild(hl);hdr.appendChild(tbr);app.appendChild(hdr);

  // ‚îÄ‚îÄ TOP BAR: drivetrain + units ‚îÄ‚îÄ
  var topbar=el('div',{class:'topbar'});
  topbar.appendChild(el('span',{style:{fontSize:'10px',color:'#64748b',fontWeight:'700',marginRight:'2px'}},'DRIVETRAIN:'));
  fwdBtn=el('button',{class:'dt-btn dt-fwd'});
  fwdBtn.innerHTML="‚ö° FWD <span style='font-size:9px;opacity:.75'>Single Motor 104 MPGe ¬∑ 312mi EPA</span>";
  fwdBtn.addEventListener('click',function(){ST.dt='fwd';track('drivetrain_click','fwd');updDT();recomputeAndAnimate();});
  awdBtn=el('button',{class:'dt-btn dt-off'});
  awdBtn.innerHTML="‚ö°‚ö° AWD <span style='font-size:9px;opacity:.75'>Dual Motor 94 MPGe 283mi</span>";
  awdBtn.addEventListener('click',function(){ST.dt='awd';track('drivetrain_click','awd');updDT();recomputeAndAnimate();});
  topbar.appendChild(fwdBtn);topbar.appendChild(awdBtn);
  topbar.appendChild(el('div',{class:'sep'}));
  topbar.appendChild(el('span',{style:{fontSize:'10px',color:'#64748b',fontWeight:'700',marginRight:'2px'}},'UNITS:'));
  var uiB=el('button',{class:'unit-btn '+(ST.metric?'boff':'bon')},'üá∫üá∏ Imperial');
  var umB=el('button',{class:'unit-btn '+(ST.metric?'bon':'boff')},'üåç Metric');
  uiB.addEventListener('click',function(){ST.metric=false;track('unit_switch','imperial');uiB.className='unit-btn bon';umB.className='unit-btn boff';try{localStorage.setItem('equinox_metric','0');}catch(e){}rebuildAll();});
  umB.addEventListener('click',function(){ST.metric=true;track('unit_switch','metric');uiB.className='unit-btn boff';umB.className='unit-btn bon';try{localStorage.setItem('equinox_metric','1');}catch(e){}rebuildAll();});
  unitBtns.imp=uiB;unitBtns.met=umB;
  topbar.appendChild(uiB);topbar.appendChild(umB);
  var epaEl=el('div',{class:'mono',style:{fontSize:'9px',color:'#64748b',marginLeft:'auto'}});
  epaEl.id='epa-el';topbar.appendChild(epaEl);
  app.appendChild(topbar);

  // ‚îÄ‚îÄ SCENARIO STRIP ‚îÄ‚îÄ
  var scWrap=el('div',{class:'sc-wrap'});
  var scTitle=el('div',{class:'sc-title'});
  scTitle.innerHTML='üéØ Real-World Scenarios <span id="custom-pill" class="custom-pill" style="display:none">‚úèÔ∏è Custom</span>';
  scWrap.appendChild(scTitle);
  var scGrid=el('div',{class:'sc-grid'});
  SCENARIOS.forEach(function(sc){
    var btn=el('button',{class:'sc-btn'+(sc.key===ST.activeScenario?' active':'')});
    btn.dataset.key=sc.key;
    btn.innerHTML='<span class="sc-icon">'+sc.icon+'</span>'+
      '<span class="sc-name">'+sc.name+'</span>'+
      '<span class="sc-sub">'+sc.sub+'</span>'+
      '<span class="sc-badge '+sc.badgeClass+'">'+sc.badge+'</span>';
    btn.addEventListener('click',function(){activateScenario(sc.key,true);});
    scGrid.appendChild(btn);
  });
  scWrap.appendChild(scGrid);
  app.appendChild(scWrap);

  // ‚îÄ‚îÄ ADVANCED PANEL (just below scenarios) ‚îÄ‚îÄ
  var advWrap=el('div',{class:'adv-wrap'});
  var advToggle=el('button',{class:'adv-toggle'});
  var advLeft=el('div',{class:'adv-toggle-left'});
  advLeft.appendChild(el('span',{class:'adv-toggle-icon'},'üîß'));
  var advTxt=el('div',null);
  advTxt.appendChild(el('div',{class:'adv-toggle-text'},'Adjust Conditions'));
  advTxt.appendChild(el('div',{class:'adv-toggle-sub'},'Fine-tune wind, grade, load, HVAC and more'));
  advLeft.appendChild(advTxt);
  var advChev=el('span',{class:'adv-chevron'+(ST.advOpen?' open':'')});
  advChev.textContent='‚åÑ';
  advToggle.appendChild(advLeft);advToggle.appendChild(advChev);
  var advBody=el('div',{class:'adv-body'+(ST.advOpen?' open':'')});
  var advInner=el('div',{class:'adv-inner'});
  advBody.appendChild(advInner);
  advToggle.addEventListener('click',function(){
    ST.advOpen=!ST.advOpen;
    advBody.className='adv-body'+(ST.advOpen?' open':'');
    advChev.className='adv-chevron'+(ST.advOpen?' open':'');
    if(ST.advOpen)buildAdvancedPanel(advInner);
  });
  advWrap.appendChild(advToggle);advWrap.appendChild(advBody);
  app.appendChild(advWrap);

  // if was open from permalink, build it immediately from current ST
  if(ST.advOpen)buildAdvancedPanel(advInner);

  // ‚îÄ‚îÄ TEMPERATURE SLIDER (always visible) ‚îÄ‚îÄ
  var tempPanel=el('div',{class:'temp-panel'});
  var tempHdr=el('div',{class:'temp-header'});
  tempHdr.appendChild(el('span',{class:'temp-label'},'üå°Ô∏è Outside Temperature'));
  var tempVal=el('span',{class:'temp-value',id:'temp-val'},dTemp(ST.ambientT));
  tempHdr.appendChild(tempVal);
  tempPanel.appendChild(tempHdr);
  var tempInp=el('input',{type:'range',min:0,max:100,step:10,value:ST.ambientT,id:'temp-inp'});
  tempInp.style.height='8px';
  tempInp.addEventListener('input',function(){
    ST.ambientT=+tempInp.value;
    markCustom();
    updateTempSliderVisual(ST.ambientT);
    ANIM.tempCur=ST.ambientT;
    ANIM.tempTgt=ST.ambientT;
    recomputeAndAnimate();
  });
  tempInp.addEventListener('change',function(){
    track('temp_set', String(ST.ambientT));
  });
  tempPanel.appendChild(tempInp);
  var TICK_TEMPS=[0,10,20,30,40,50,60,70,80,90,100];
  var tickRow=el('div',{class:'temp-ticks'});
  TICK_TEMPS.forEach(function(t){
    var tk=el('span',{class:'temp-tick',style:{color:t===ST.ambientT?'#60a5fa':'#475569',fontWeight:t===ST.ambientT?'700':'400'}},dTemp(t));
    tickRow.appendChild(tk);
  });
  tempPanel.appendChild(tickRow);
  app.appendChild(tempPanel);

  // ‚îÄ‚îÄ TAB CONTENT ‚îÄ‚îÄ
  tabContent=el('div',null);app.appendChild(tabContent);

  // ‚îÄ‚îÄ QUICK BOXES ‚îÄ‚îÄ
  var qg=el('div',{class:'qgrid'});qg.id='qg';app.appendChild(qg);buildQuick(qg);

  // ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ
  app.appendChild(el('div',{style:{marginTop:'10px',textAlign:'center',fontSize:'9px',color:'#90EE90',paddingBottom:'14px'}},
    'Equinox EV Efficiency Model | Physics-based educational tool | 2024‚Äì2026 | created by gazunni'),el('div',{style:{marginTop:'5px',fontSize:'8px',color:'#334155',maxWidth:'700px',margin:'5px auto 0',lineHeight:'1.6',textAlign:'center'}},
    'Physics-based educational tool. Results are modelled estimates for informational purposes only ‚Äî not for trip planning or safety-critical decisions. Real-world range varies with driving behaviour, vehicle condition, and factors not captured in this model. Not affiliated with or endorsed by General Motors Corporation.'));

  updDT();updateEpaLabel();

  // compute base heights once
  ANIM.baseH=getBaseEffs();

  // init with January Commute (no animation on first load, then animate in)
  var initEffs=SPEEDS.map(function(mph){
    var r=calcI(mph,ST.ambientT,ST.dt,ST.cabinT,ST.seat,ST.whl,ST.defrost,
               ST.wind,ST.pax,ST.cargo,ST.roof,ST.psi,ST.grade,ST.traffic,ST.solar,ST.alt,ST.soh);
    return ST.metric?+(r.eff*1.60934).toFixed(3):+r.eff.toFixed(3);
  });

  // start from base case visually, then animate to scenario
  ANIM.curH=ANIM.baseH.slice();
  ANIM.tempCur=BASE_CASE.ambientT;
  updateTempSliderVisual(BASE_CASE.ambientT);

  setView(ST.view);
  updateConditionsLine();
  updateEpaLabel();

  // delay opening animation so DOM is settled
  setTimeout(function(){
    var sc=window.__LANDING_SCENARIO__||ST.activeScenario||'jan_commute';
    activateScenario(sc,true);
    track('page_view','blazer_calculator');
  },350);
}

function updDT(){
  if(fwdBtn)fwdBtn.className='dt-btn '+(ST.dt==='fwd'?'dt-fwd':'dt-off');
  if(awdBtn)awdBtn.className='dt-btn '+(ST.dt==='awd'?'dt-awd':'dt-off');
  // recompute base heights for this drivetrain
  ANIM.baseH=getBaseEffs();
}

function updateEpaLabel(){
  var ep=$id('epa-el');
  if(ep){var c=CFG[ST.dt];var weff=(c.mpge/33.705);var weffD=ST.metric?(weff*1.60934).toFixed(3):weff.toFixed(3);ep.textContent=c.label+' | EPA '+c.epa_mi+' mi | '+c.mpge+' MPGe | '+weffD+' '+dUnit()+' wall-to-wheels';}
}

// ================================================================
// ADVANCED PANEL BUILD
// ================================================================
function buildAdvancedPanel(wrap){
  wrap.innerHTML='';
  advSliderRefs={};
  var sgrid=el('div',{class:'sgrid'});

  // Section 1: Cabin & Wind
  var s1=el('div',{class:'sec'});
  s1.appendChild(mkLbl('#60a5fa','üå°Ô∏è Cabin & Wind'));
  var cabMin=ST.metric?16:60,cabMax=ST.metric?30:85;
  var cabVal=ST.metric?Math.round(fToC(ST.cabinT)*2)/2:ST.cabinT;
  var cabSlider=mkSlider({label:'Cabin Setpoint',emoji:'üå°Ô∏è',value:cabVal,min:cabMin,max:cabMax,step:ST.metric?0.5:1,
    unit:ST.metric?' C':' F',color:'#60a5fa',
    onChange:function(v){ST.cabinT=ST.metric?cToF(v):v;markCustom();recomputeAndAnimate();}});
  s1.appendChild(cabSlider);
  var wVal=ST.metric?Math.round(mToK(ST.wind)):ST.wind;
  s1.appendChild(mkSlider({label:'Headwind / Tailwind',emoji:'üí®',value:wVal,
    min:ST.metric?-32:-20,max:ST.metric?64:40,step:ST.metric?8:5,color:'#f87171',
    fmt:function(v){if(v===0)return'Calm';return ST.metric?(v>0?'+':'')+v+' km/h':(v>0?'+'+v+' mph':v+' mph');},
    onChange:function(v){ST.wind=ST.metric?kToM(v):v;markCustom();recomputeAndAnimate();}}));
  sgrid.appendChild(s1);

  // Section 2: Grade, Tires & Altitude
  var s2=el('div',{class:'sec'});
  s2.appendChild(mkLbl('#34d399','üõû Grade, Tires & Altitude'));
  s2.appendChild(mkSlider({label:'Road Grade',emoji:'‚õ∞Ô∏è',value:ST.grade,min:-6,max:8,step:0.5,color:'#34d399',
    fmt:function(v){return v>0?'+'+v+'%':v<0?v+'%':'Level';},
    onChange:function(v){ST.grade=v;markCustom();recomputeAndAnimate();}}));
  s2.appendChild(mkSlider({label:'Tire Pressure',emoji:'üõû',value:ST.psi,min:20,max:50,step:1,unit:' PSI',
    color:'#90EE90',sub:'Nominal 42 PSI',
    onChange:function(v){ST.psi=v;markCustom();recomputeAndAnimate();}}));
  var altVal=ST.metric?Math.round(ST.alt*0.3048):ST.alt;
  s2.appendChild(mkSlider({label:'Altitude',emoji:'üèîÔ∏è',value:altVal,min:0,max:ST.metric?2440:8000,
    step:ST.metric?100:500,color:'#2dd4bf',
    fmt:function(v){return ST.metric?v+'m':v+' ft';},
    sub:'Denver=5280ft | thinner air = less drag',
    onChange:function(v){ST.alt=ST.metric?Math.round(v/0.3048):v;markCustom();recomputeAndAnimate();}}));
  sgrid.appendChild(s2);

  // Section 3: Comfort Heaters
  var s3=el('div',{class:'sec'});
  s3.appendChild(mkLbl('#fbbf24','üî• Comfort Heaters'));
  function mkTog(label,emoji,sub,watts,stKey){
    var t=mkToggle({label:label,emoji:emoji,sub:sub,watts:watts,value:ST[stKey],
      onChange:function(v){ST[stKey]=v;markCustom();recomputeAndAnimate();}});
    t.querySelector('.ttrack').id='tog-'+stKey;
    return t;
  }
  s3.appendChild(mkTog('Seat Heaters x2','ü™ë','140W resistive',140,'seat'));
  s3.appendChild(mkTog('Steering Wheel','üé°','25W resistive',25,'whl'));
  s3.appendChild(mkTog('Rear Defrost + Mirrors','ü™ü','~250W (auto-off ~10 min)',250,'defrost'));
  var hld=el('div',{style:{fontSize:'9px',color:'#64748b',marginTop:'2px'}});hld.id='hld';s3.appendChild(hld);
  var w=(ST.seat?140:0)+(ST.whl?25:0)+(ST.defrost?250:0);hld.textContent='üîå Heaters: '+(w>0?w+'W':'none');
  sgrid.appendChild(s3);

  // Section 4: Load
  var s4=el('div',{class:'sec'});
  s4.appendChild(mkLbl('#a78bfa','üì¶ Load'));
  s4.appendChild(mkSlider({label:'Occupants',emoji:'üë•',value:ST.pax,min:1,max:5,step:1,color:'#a78bfa',
    fmt:function(v){return v===1?'üßë Solo':v===2?'üë´ 2 people':v===3?'üë®‚Äçüë©‚Äçüë¶ 3 people':'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ '+v+' people';},
    onChange:function(v){ST.pax=v;markCustom();recomputeAndAnimate();}}));
  var cgVal=ST.metric?Math.round(ST.cargo*0.4536):ST.cargo;
  s4.appendChild(mkSlider({label:'Cargo',emoji:'üß≥',value:cgVal,min:0,max:ST.metric?225:500,step:ST.metric?10:25,
    unit:ST.metric?' kg':' lb',color:'#8b5cf6',
    onChange:function(v){ST.cargo=ST.metric?v/0.4536:v;markCustom();recomputeAndAnimate();}}));
  s4.appendChild(mkTog('Roof Cargo Box','üì¶','Cd+0.10, A+0.25m¬≤',0,'roof'));
  s4.appendChild(mkSlider({label:'Battery Health (SOH)',emoji:'üîã',value:ST.soh,min:80,max:100,step:1,unit:'%',
    color:'#f59e0b',sub:'100%=new ¬∑ 80%‚âà8yr ¬∑ affects range, not mi/kWh shown',
    fmt:function(v){return v===100?'100% (new)':v+'%';},
    onChange:function(v){ST.soh=v;markCustom();recomputeAndAnimate();}}));
  sgrid.appendChild(s4);

  // Section 5: Traffic & Solar
  var s5=el('div',{class:'sec'});
  s5.appendChild(mkLbl('#f472b6','üö¶ Traffic & Solar'));
  s5.appendChild(el('div',{style:{fontSize:'9px',color:'#64748b',fontWeight:'700',marginBottom:'4px',textTransform:'uppercase',letterSpacing:'.05em'}},'üöó Traffic Mode'));
  var tmRow=el('div',{style:{display:'flex',gap:'4px',marginBottom:'8px'}});
  [['cruise','üõ£Ô∏è Cruise','#334155'],['mixed','üöô Mixed','#854d0e'],['stopgo','üõë Stop & Go','#7c2d12']].forEach(function(r){
    var b=el('button',{style:{flex:'1',padding:'6px 4px',borderRadius:'5px',fontSize:'9px',fontWeight:'700',
      border:'none',cursor:'pointer',lineHeight:'1.4',
      background:ST.traffic===r[0]?r[2]:'#1e293b',color:ST.traffic===r[0]?'#fff':'#64748b'}},r[1]);
    b.addEventListener('click',function(){
      ST.traffic=r[0];markCustom();
      tmRow.querySelectorAll('button').forEach(function(btn,i){
        var m=[['cruise','#334155'],['mixed','#854d0e'],['stopgo','#7c2d12']];
        btn.style.background=m[i][0]===r[0]?m[i][1]:'#1e293b';
        btn.style.color=m[i][0]===r[0]?'#fff':'#64748b';
      });
      recomputeAndAnimate();
    });
    tmRow.appendChild(b);
  });
  s5.appendChild(tmRow);
  s5.appendChild(el('div',{style:{fontSize:'8px',color:'#90EE90',marginBottom:'8px',lineHeight:'1.5'}},
    'Cruise=full speed ¬∑ Mixed=72% avg ¬∑ Stop-Go=38% avg. HVAC costs more per km when moving slowly. Traction power unchanged.'));
  s5.appendChild(el('div',{style:{fontSize:'9px',color:'#64748b',fontWeight:'700',marginBottom:'4px',textTransform:'uppercase',letterSpacing:'.05em'}},'‚òÄÔ∏è Solar Gain (A/C only)'));
  var solRow=el('div',{style:{display:'flex',gap:'4px',marginBottom:'6px'}});
  [['none','‚òÅÔ∏è No Sun','#334155'],['partial','‚õÖ Partly','#78350f'],['full','‚òÄÔ∏è Full Sun','#92400e']].forEach(function(r){
    var b=el('button',{style:{flex:'1',padding:'6px 4px',borderRadius:'5px',fontSize:'9px',fontWeight:'700',
      border:'none',cursor:'pointer',lineHeight:'1.4',
      background:ST.solar===r[0]?r[2]:'#1e293b',color:ST.solar===r[0]?'#fff':'#64748b'}},r[1]);
    b.addEventListener('click',function(){
      ST.solar=r[0];markCustom();
      solRow.querySelectorAll('button').forEach(function(btn,i){
        var s=[['none','#334155'],['partial','#78350f'],['full','#92400e']];
        btn.style.background=s[i][0]===r[0]?s[i][1]:'#1e293b';
        btn.style.color=s[i][0]===r[0]?'#fff':'#64748b';
      });
      recomputeAndAnimate();
    });
    solRow.appendChild(b);
  });
  s5.appendChild(solRow);
  s5.appendChild(el('div',{style:{fontSize:'8px',color:'#90EE90',lineHeight:'1.5'}},
    '~500W through glass on sunny day. Only affects cooling (AC).'));
  sgrid.appendChild(s5);

  wrap.appendChild(sgrid);
}

// ================================================================
// QUICK BOXES
// ================================================================
function buildQuick(wrap){
  while(wrap.firstChild)wrap.removeChild(wrap.firstChild);
  quickBoxes=[];
  [[40,80],[60,60],[70,20],[80,0]].forEach(function(q){
    var box=el('div',{class:'qbox'});
    var v1=el('div',{class:'mono',style:{fontSize:'17px',fontWeight:'700'}});
    var v2=el('div',{class:'mono',style:{fontSize:'11px',marginTop:'2px'}});
    var ls=ST.metric?Math.round(mToK(q[0]))+'km/h':q[0]+'mph';
    var lt=ST.metric?Math.round(fToC(q[1]))+'\u00b0C':q[1]+'\u00b0F';
    box.appendChild(v1);box.appendChild(v2);
    box.appendChild(el('div',{style:{fontSize:'9px',color:'#64748b',marginTop:'3px'}},ls+' / '+lt));
    wrap.appendChild(box);
    quickBoxes.push({v1:v1,v2:v2,mph:q[0],t:q[1]});
  });
  updateQuickBoxes();
}

function updateQuickBoxes(){
  quickBoxes.forEach(function(q){
    var p=calcI(q.mph,q.t,ST.dt,BASE_CASE.cabinT,false,false,false,0,1,0,false,42,0,'cruise','none',0,100);
    var epa=epaEff(ST.dt);
    var eff=ST.metric?p.eff*1.60934:p.eff;
    q.v1.textContent=dEff(p.eff);q.v1.style.color=effCol(p.eff,ST.dt);
    var pct=(eff-epa)/epa*100;
    q.v2.textContent=(pct>=0?'+':'')+pct.toFixed(1)+'% EPA';
    q.v2.style.color=pct>5?'#22c55e':pct>0?'#86efac':pct>-5?'#facc15':pct>-15?'#f97316':'#ef4444';
  });
}

// ================================================================
// VIEWS
// ================================================================
function setView(v){
  Object.keys(viewBtns).forEach(function(k){viewBtns[k].className='btn '+(k===v?'bon':'boff');});
  while(tabContent.firstChild)tabContent.removeChild(tabContent.firstChild);
  if(v==='chart')bChart();
  else if(v==='breakdown')bBd();
  else if(v==='table')bTable();
  else bModel();
}

function rebuildAll(){
  // recompute base heights
  ANIM.baseH=getBaseEffs();
  // rebuild quick boxes
  var qg=$id('qg');if(qg)buildQuick(qg);
  // rebuild advanced panel if open
  var advInner=document.querySelector('.adv-inner');
  if(advInner&&ST.advOpen)buildAdvancedPanel(advInner);
  // update temp ticks
  var ticks=document.querySelectorAll('.temp-tick');
  var TICK_TEMPS=[0,10,20,30,40,50,60,70,80,90,100];
  ticks.forEach(function(tk,i){tk.textContent=dTemp(TICK_TEMPS[i]);});
  updateTempSliderVisual(ST.ambientT);
  updateEpaLabel();
  recomputeAndAnimate();
  setView(ST.view);
}

// ================================================================
// CHART VIEW
// ================================================================
function bChart(){
  var card=el('div',{class:'chart-card'});

  var meta=el('div',{class:'chart-meta'});
  var tl=el('div',null);
  tl.appendChild(el('div',{class:'chart-title'},'üìä '+dUnit()+' vs Speed ‚Äî '+ST.dt.toUpperCase()));
  tl.appendChild(el('div',{class:'chart-hint'},'Modelled estimates ¬∑ Solid = current conditions ¬∑ Ghost outline = Perfect Day (70¬∞F, calm, solo, cruise) ¬∑ Red gap = penalty ¬∑ Hover bars for details'));
  meta.appendChild(tl);
  var cond=el('div',{class:'chart-conditions',id:'chart-cond'});
  meta.appendChild(cond);
  card.appendChild(meta);

  var cwrap=el('div',{class:'cwrap'});
  chartCanvas=document.createElement('canvas');
  chartTip=el('div',{class:'tip'});
  cwrap.appendChild(chartCanvas);cwrap.appendChild(chartTip);
  card.appendChild(cwrap);

  // delta strip skeleton
  var ds=el('div',{class:'delta-strip',id:'delta-strip'});
  SPEEDS.forEach(function(mph,i){
    var box=el('div',{class:'dbox',id:'dbox-'+i});
    box.appendChild(el('div',{class:'dbox-spd'},ST.metric?Math.round(mToK(mph))+' km/h':mph+' mph'));
    box.appendChild(el('div',{class:'dbox-eff mono'},'‚Äî'));
    box.appendChild(el('div',{class:'dbox-range mono'},''));
    box.appendChild(el('div',{class:'dbox-delta mono'},''));
    box.appendChild(el('div',{class:'dbox-mi'},''));
    ds.appendChild(box);
  });
  card.appendChild(ds);
  card.appendChild(el('div',{style:{fontSize:'8px',color:'#475569',marginTop:'6px',textAlign:'right',fontStyle:'italic'}},
    '~ Modelled range estimates for educational purposes only. Actual range varies with driving conditions and vehicle state.'));
  tabContent.appendChild(card);

  // canvas events ‚Äî click/tap to PIN, click/tap again to close
  var pinnedTip=null;

  function buildEpaTip(epa){
    return '<b style="color:#facc15">&#128202; EPA Reference Line</b><br><br>'+
      '<span style="color:#94a3b8">GM combined: </span><b style="color:#facc15">'+epa.toFixed(2)+' '+dUnit()+'</b><br><br>'+
      '<span style="color:#cbd5e1">Wall-to-wheels measurement ‚Äî energy from your L2 charger including charging losses (~20%). Standardized city/highway cycle averaged.</span><br><br>'+
      '<span style="color:#cbd5e1">This app shows one speed, one temperature. Highway cruising in mild weather beats the combined EPA figure ‚Äî just as ICE highway MPG beats combined MPG.</span><br><br>'+
      '<span style="color:#90EE90">Official figure: MPGe √∑ 33.705. Bars above = beat EPA.</span>'+
      '<br><span style="color:#3d6080;font-size:10px">tap/click again to close</span>';
  }

  function buildBarTip(best){
    var epa=epaEff(ST.dt);
    var pct=((best.eff-epa)/epa*100).toFixed(1);
    var sign=+pct>=0?'+':'';
    var rng=Math.round((ST.metric?best.eff/1.60934:best.eff)*CFG[ST.dt].pack*(ST.soh/100));
    var bdelta=best.eff-best.baseEff;
    var bpct=best.baseEff>0?(bdelta/best.baseEff*100).toFixed(1):'0';
    return '<b style="color:#fff">&#128663; '+dSpeed(best.mph)+'</b><br>'+
      '<span style="color:#94a3b8">Efficiency: </span><b style="color:'+best.col+'">'+dEffL(best.eff)+' '+dUnit()+'</b><br>'+
      '<span style="color:#94a3b8">vs EPA: </span><b style="color:'+(+pct>=0?'#22c55e':+pct>-5?'#facc15':'#f97316')+'">'+sign+pct+'%</b><br>'+
      '<span style="color:#94a3b8">vs Perfect Day: </span><b style="color:'+(bdelta>=0?'#22c55e':'#f87171')+'">'+(bdelta>=0?'+':'')+dEffL(bdelta)+' ('+( +bpct>=0?'+':'')+bpct+'%)</b>'+
      (Math.abs(bdelta)>0.01?'<br><span style="color:#475569;font-size:10px">Ghost = Perfect Day. Gap = conditions penalty.</span>':'')+
      '<br><span style="color:#94a3b8">&#128283; Range: </span><b style="color:#e2e8f0">'+dRange(rng)+'</b>'+
      '<br><span style="color:#3d6080;font-size:10px">tap/click again to close</span>';
  }

  function showTip(html, maxW, tx, ty){
    chartTip.innerHTML=html;
    chartTip.style.maxWidth=maxW+'px';
    chartTip.style.lineHeight='1.8';
    chartTip.style.display='block';
    chartTip.style.left=tx+'px';
    chartTip.style.top=ty+'px';
  }

  function tipPos(r, refX, refY, tipW){
    var tx=refX+14;
    if(tx+tipW>r.width)tx=refX-tipW-8;
    if(tx<4)tx=4;
    var ty=Math.max(8,Math.min(refY-20,r.height-260));
    return{tx:tx,ty:ty};
  }

  // MOUSEMOVE ‚Äî preview only when nothing pinned
  chartCanvas.addEventListener('mousemove',function(ev){
    if(pinnedTip)return;
    if(!chartCanvas._zones)return;
    var r=chartCanvas.getBoundingClientRect();
    var mx=ev.clientX-r.left,my=ev.clientY-r.top;
    var ez=chartCanvas._epaZone;
    if(ez&&mx>=ez.x&&mx<=ez.x+ez.w&&my>=ez.y&&my<=ez.y+ez.h){
      var p=tipPos(r,ez.x,ez.y,290);
      showTip(buildEpaTip(ez.epa),280,p.tx,p.ty);
      chartCanvas.style.cursor='pointer';return;
    }
    chartCanvas.style.cursor='default';
    var best=null,bestD=55;
    chartCanvas._zones.forEach(function(z){var d=Math.abs(z.cx-mx);if(d<bestD){bestD=d;best=z;}});
    if(best){
      var p=tipPos(r,ev.clientX-r.left,60,220);
      showTip(buildBarTip(best),220,p.tx,p.ty);
      chartCanvas.style.cursor='pointer';
    }else{chartTip.style.display='none';}
  });

  // MOUSELEAVE ‚Äî hide only if not pinned
  chartCanvas.addEventListener('mouseleave',function(){
    if(!pinnedTip)chartTip.style.display='none';
    chartCanvas.style.cursor='default';
  });

  // CLICK ‚Äî pin on first, unpin on second or empty
  chartCanvas.addEventListener('click',function(ev){
    var r=chartCanvas.getBoundingClientRect();
    var mx=ev.clientX-r.left,my=ev.clientY-r.top;
    var ez=chartCanvas._epaZone;
    if(ez&&mx>=ez.x&&mx<=ez.x+ez.w&&my>=ez.y&&my<=ez.y+ez.h){
      if(pinnedTip==='epa'){pinnedTip=null;chartTip.style.display='none';}
      else{pinnedTip='epa';var p=tipPos(r,ez.x,ez.y,290);showTip(buildEpaTip(ez.epa),280,p.tx,p.ty);}
      return;
    }
    var best=null,bestD=55;
    chartCanvas._zones.forEach(function(z){var d=Math.abs(z.cx-mx);if(d<bestD){bestD=d;best=z;}});
    if(best){
      if(pinnedTip===best){pinnedTip=null;chartTip.style.display='none';}
      else{pinnedTip=best;var p=tipPos(r,ev.clientX-r.left,60,220);showTip(buildBarTip(best),220,p.tx,p.ty);}
      return;
    }
    pinnedTip=null;chartTip.style.display='none';
  });

  // TOUCH ‚Äî tap to pin, tap same or empty to close
  chartCanvas.addEventListener('touchstart',function(ev){
    var r=chartCanvas.getBoundingClientRect();
    var t=ev.touches[0];
    var mx=t.clientX-r.left,my=t.clientY-r.top;
    var ez=chartCanvas._epaZone;
    if(ez&&mx>=ez.x&&mx<=ez.x+ez.w&&my>=ez.y&&my<=ez.y+ez.h){
      ev.preventDefault();
      if(pinnedTip==='epa'){pinnedTip=null;chartTip.style.display='none';}
      else{
        pinnedTip='epa';
        showTip(buildEpaTip(ez.epa),260,
          Math.max(4,Math.min(r.width-270,r.width/2-130)),8);
      }
      return;
    }
    var best=null,bestD=55;
    chartCanvas._zones.forEach(function(z){var d=Math.abs(z.cx-mx);if(d<bestD){bestD=d;best=z;}});
    if(best){
      ev.preventDefault();
      if(pinnedTip===best){pinnedTip=null;chartTip.style.display='none';}
      else{
        pinnedTip=best;
        showTip(buildBarTip(best),220,
          Math.max(4,Math.min(r.width-230,r.width/2-110)),50);
      }
      return;
    }
    if(pinnedTip){pinnedTip=null;chartTip.style.display='none';}
  },{passive:false});

  try{new ResizeObserver(function(){drawChart();}).observe(cwrap);}catch(e){}
  updateConditionsLine();
  setTimeout(drawChart,0);
}

// ================================================================
// BREAKDOWN VIEW
// ================================================================
function bBd(){
  var card=el('div',{class:'card'});
  card.appendChild(el('div',{style:{fontSize:'13px',fontWeight:'700',color:'#e2e8f0',marginBottom:'11px'}},
    '‚ö° Power Breakdown ‚Äî '+dTemp(ST.ambientT)+' ambient'));
  var srow=el('div',{style:{display:'flex',gap:'12px',flexWrap:'wrap',marginBottom:'12px'}});
  var sd=el('div',null);
  sd.appendChild(el('div',{style:{fontSize:'9px',color:'#64748b',fontWeight:'700',marginBottom:'3px'}},'üöó SPEED'));
  var sbr=el('div',{style:{display:'flex',gap:'4px'}});var sbtns={};
  SPEEDS.forEach(function(s){
    var lbl=ST.metric?Math.round(mToK(s)):s;
    var b=el('button',{style:{padding:'5px 9px',borderRadius:'5px',fontFamily:'var(--mono)',
      fontWeight:'700',fontSize:'12px',border:'none',cursor:'pointer',
      background:ST.selSpd===s?'#2563eb':'#1e293b',color:ST.selSpd===s?'#fff':'#94a3b8'}},String(lbl));
    b.addEventListener('click',function(){ST.selSpd=s;
      Object.keys(sbtns).forEach(function(k){sbtns[k].style.background=+k===s?'#2563eb':'#1e293b';sbtns[k].style.color=+k===s?'#fff':'#94a3b8';});
      updBd();});
    sbtns[s]=b;sbr.appendChild(b);
  });
  sd.appendChild(sbr);srow.appendChild(sd);
  var dd=el('div',null);
  dd.appendChild(el('div',{style:{fontSize:'9px',color:'#64748b',fontWeight:'700',marginBottom:'3px'}},'‚ö° DRIVETRAIN'));
  var dbr=el('div',{style:{display:'flex',gap:'4px'}});var dbbtns={};
  [['fwd','‚ö° FWD','#2563eb'],['awd','‚ö°‚ö° AWD','#7c3aed']].forEach(function(r){
    var b=el('button',{style:{padding:'5px 12px',borderRadius:'5px',fontWeight:'700',fontSize:'12px',border:'none',
      cursor:'pointer',background:ST.dt===r[0]?r[2]:'#1e293b',color:ST.dt===r[0]?'#fff':'#94a3b8'}},r[1]);
    b.addEventListener('click',function(){ST.dt=r[0];updDT();
      [['fwd','#2563eb'],['awd','#7c3aed']].forEach(function(x){dbbtns[x[0]].style.background=ST.dt===x[0]?x[1]:'#1e293b';dbbtns[x[0]].style.color=ST.dt===x[0]?'#fff':'#94a3b8';});
      updBd();});
    dbbtns[r[0]]=b;dbr.appendChild(b);
  });
  dd.appendChild(dbr);srow.appendChild(dd);
  card.appendChild(srow);
  var strip=el('div',{class:'mini sum-strip'});strip.id='bd-strip';card.appendChild(strip);
  var barsDiv=el('div',null);barsDiv.id='bd-bars';card.appendChild(barsDiv);
  tabContent.appendChild(card);
  updBd();

  function updBd(){
    var c=CFG[ST.dt],bd=c6(ST.selSpd,ST.ambientT,ST.dt);
    var tot=bd.Pb/1000,effD=ST.metric?bd.eff*1.60934:bd.eff;
    var ss=$id('bd-strip');ss.innerHTML='';
    [['üîå Battery',(bd.Pb/1000).toFixed(2)+' kW','#fff'],
     [dUnit(),effD.toFixed(3),effCol(bd.eff,ST.dt)],
     ['üó∫Ô∏è Modelled Range',dRange(Math.round(bd.eff*(c.pack*(ST.soh/100)))),'#e2e8f0'],
     ['üí® Aero Speed',dSpeed(ST.selSpd+ST.wind),ST.wind!==0?'#fbbf24':'#94a3b8'],
     ['‚öñÔ∏è Total Mass',dMass(bd.mass),'#a78bfa'],
     ['üå°Ô∏è Cabin dT',Math.abs(ST.cabinT-ST.ambientT)+(ST.metric?' C':' F'),Math.abs(ST.cabinT-ST.ambientT)>30?'#f87171':'#94a3b8']
    ].forEach(function(r){
      var d=el('div',{style:{textAlign:'center'}});
      d.appendChild(el('div',{style:{fontSize:'9px',color:'#64748b',fontWeight:'600',marginBottom:'2px'}},r[0]));
      d.appendChild(el('div',{class:'mono',style:{fontSize:'17px',fontWeight:'700',color:r[2]}},r[1]));
      ss.appendChild(d);
    });
    var bars=$id('bd-bars');bars.innerHTML='';
    [['üí® Aero Drag (v='+dSpeed(ST.selSpd+ST.wind)+')','#3b82f6',bd.Pa,'0.5*rho*Cd*A*v¬≥'],
     ['üõû Rolling Resistance','#8b5cf6',bd.Pr,'Crr='+bd.Crr.toFixed(4)+(c.awd?' +AWD bearing':'')],
     ['‚õ∞Ô∏è Road Grade ('+ST.grade+'%)','#6366f1',bd.Pg,ST.grade===0?'Level road':ST.grade>0?'Uphill':'Downhill'],
     ['‚öôÔ∏è Drivetrain Loss (eta='+c.eta+')','#4f46e5',bd.Pt-(bd.Pa+bd.Pr+bd.Pg),c.awd?'Dual motor':'Single motor'],
     ['üå°Ô∏è HVAC dT='+Math.abs(ST.cabinT-ST.ambientT)+(ST.metric?' C':' F')+' COP='+(ST.ambientT<ST.cabinT?hpCOP(ST.ambientT):acCOP(ST.ambientT)).toFixed(1),'#f59e0b',bd.Ph,ST.ambientT<ST.cabinT?'üî• Heat pump':'‚ùÑÔ∏è A/C'],
     ['ü™ë Seat Heaters ('+(ST.seat?'ON':'OFF')+')','#f97316',bd.Ps,'140W'],
     ['üé° Wheel Heater ('+(ST.whl?'ON':'OFF')+')','#fb923c',bd.Pw,'25W'],
     ['ü™ü Rear Defrost ('+(ST.defrost?'ON':'OFF')+')','#e879f9',bd.Pd,'~250W grid'],
     ['üîå Base Accessories','#64748b',PACC,'400W fixed'],
     ['üö¶ Traffic HVAC scale ('+TRAFFIC_MODES[ST.traffic].label+')','#f472b6',bd.Ph-bd.Ph_raw,'Per-mile HVAC scaling'],
     [(SOLAR_LOADS[ST.solar]>0?'‚òÄÔ∏è':'üí°')+' Solar+Occupant heat','#fbbf24',bd.solarW+bd.occupantW,bd.solarW>0?'Solar '+bd.solarW+'W + occupants '+bd.occupantW+'W':'Occupant heat '+bd.occupantW+'W (AC only)'],
     ['üîã Battery Ri Loss (eta='+bd.be.toFixed(3)+')','#ec4899',bd.Pb-(bd.Pt+bd.Ph+bd.Ps+bd.Pw+bd.Pd+PACC),'Low-temp resistance loss'],
    ].forEach(function(r){
      var val=r[2]/1000,pct=Math.min(100,Math.max(0,(val/tot)*100));
      var w2=el('div',{style:{marginBottom:'9px'}});
      var rw=el('div',{style:{display:'flex',justifyContent:'space-between',fontSize:'10px',marginBottom:'2px'}});
      rw.appendChild(el('span',{style:{color:'#cbd5e1'}},r[0]));
      var rv=el('span',{class:'mono',style:{color:'#e2e8f0'}});
      rv.textContent=val.toFixed(2)+' kW ';
      rv.appendChild(el('span',{style:{color:'#475569'}},'('+pct.toFixed(0)+'%)'));
      rw.appendChild(rv);w2.appendChild(rw);
      var bg=el('div',{class:'barbg'});
      bg.appendChild(el('div',{class:'barfill',style:{width:Math.max(pct,val>0?1:0)+'%',background:r[1]}}));
      w2.appendChild(bg);
      if(r[3])w2.appendChild(el('div',{class:'mono',style:{fontSize:'9px',color:'#475569',marginTop:'1px'}},r[3]));
      bars.appendChild(w2);
    });
  }
}

// ================================================================
// TABLE VIEW
// ================================================================
function bTable(){
  var card=el('div',{class:'card',style:{overflowX:'auto'}});
  card.appendChild(el('div',{style:{fontSize:'13px',fontWeight:'700',color:'#e2e8f0',marginBottom:'8px'}},
    'üìã Data Table ‚Äî '+dUnit()+' | kW | modelled range (estimate)'));
  ['fwd','awd'].forEach(function(dk){
    var c=CFG[dk];
    var er=ST.metric?Math.round(mToK(c.epa_mi))+' km':c.epa_mi+' mi';
    var hd=el('div',{style:{fontSize:'10px',fontWeight:'700',margin:'10px 0 4px',color:dk==='fwd'?'#60a5fa':'#a78bfa'}});
    hd.textContent=(dk==='fwd'?'‚ö° ':'‚ö°‚ö° ')+c.label+' ‚Äî EPA '+er+' | '+c.mpge+' MPGe | eta='+c.eta+' | '+c.pack+' kWh';
    card.appendChild(hd);
    var tbl=el('table',null);
    var thead=el('thead',null),hr=el('tr',null);
    hr.appendChild(el('th',null,'üöó Speed'));
    TEMPS_F.forEach(function(t,i){hr.appendChild(el('th',{style:{color:TCLR[i]}},dTemp(t)));});
    thead.appendChild(hr);tbl.appendChild(thead);
    var tbody=el('tbody',null);
    SPEEDS.forEach(function(mph){
      var row=el('tr',null);
      row.appendChild(el('td',{class:'mono',style:{fontWeight:'700',color:'#e2e8f0'}},dSpeed(mph)));
      TEMPS_F.forEach(function(t){
        var p=calcI(mph,t,dk,BASE_CASE.cabinT,false,false,false,0,1,0,false,42,0,'cruise','none',0,100);
        var eff=ST.metric?p.eff*1.60934:p.eff;
        var col=effCol(p.eff,dk);
        var td2=el('td',null);
        td2.appendChild(el('div',{class:'mono',style:{fontWeight:'700',fontSize:'12px',color:col}},eff.toFixed(2)));
        td2.appendChild(el('div',{class:'mono',style:{fontSize:'9px',color:'#64748b'}},(p.Pb/1000).toFixed(1)+' kW'));
        td2.appendChild(el('div',{class:'mono',style:{fontSize:'9px',color:'#475569'}},'üîã ~'+dRange(Math.round(p.eff*(c.pack*(ST.soh/100))))));
        row.appendChild(td2);
      });
      tbody.appendChild(row);
    });
    tbl.appendChild(tbody);card.appendChild(tbl);
  });
  tabContent.appendChild(card);
}

// ================================================================
// MODEL VIEW
// ================================================================
function bModel(){
  var card=el('div',{class:'card'});
  card.appendChild(el('div',{style:{fontSize:'13px',fontWeight:'700',color:'#e2e8f0',marginBottom:'10px'}},
    'üî¨ Engineering Model ‚Äî Parameters & Equations'));
  var pg=el('div',{style:{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(210px,1fr))',gap:'6px',marginBottom:'10px'}});
  [['‚öñÔ∏è Base mass (FWD)','2162 kg (4768 lb) estimated'],['‚öñÔ∏è AWD extra mass','+179 kg (rear motor+diff)'],
   ['üí® Drag coefficient Cd','~0.31 est (not published by GM) | +0.10 roof box'],['üìê Frontal area A','2.748 m¬≤ | +0.25 roof box'],
   ['‚ö° FWD drivetrain eta','87.8% (EPA 104 MPGe, Cd est.)'],['‚ö°‚ö° AWD drivetrain eta','81.2% (EPA 94 MPGe, Cd est. wall)'],
   ['‚öôÔ∏è AWD rear bearing drag','Crr +0.0004 equiv.'],['üõû Rolling resistance Crr','0.009 @42 PSI nominal'],
   ['üõû Crr pressure sensitivity','+0.00015 per PSI under 36'],['üå°Ô∏è Cabin heat transfer UA','160 W/¬∞F'],
   ['üî• Heat pump COP @0¬∞F','1.0 (full PTC resistive)'],['üî• Heat pump COP @20¬∞F','1.55'],
   ['üî• Heat pump COP @45¬∞F+','2.5‚Äì3.0'],['‚ùÑÔ∏è A/C COP (base)','3.0 | ‚àí5‚Äì12% traffic penalty'],
   ['‚òÄÔ∏è Solar gain full sun','500W thermal through glass'],['üë§ Occupant metabolic heat','100W per person (AC)'],
   ['üîã Battery eta @60¬∞F+','1.000'],['üîã Battery eta @40¬∞F','0.975'],
   ['üîã Battery eta @20¬∞F','0.945'],['üîã Battery eta @5¬∞F','0.905'],
   ['üîã Battery eta @0¬∞F','0.875'],['üîã Usable pack','79 kWh (GM rated) ‚Äî real-world new vehicle ~89‚Äì90 kWh reported'],
   ['üìä EPA efficiency basis','Wall-to-wheels (MPGe√∑33.705): FWD=3.086 mi/kWh ¬∑ AWD=2.789 mi/kWh //204 mi/kWh | AWD=2.848 mi/kWh'],
   ['üîå Base accessories','400W (12V, lights, ctrl)'],['ü™ë Seat heaters x2','140W resistive'],
   ['üé° Steering wheel heater','25W resistive'],['ü™ü Rear defrost+mirrors','~250W resistive'],
   ['üîã Base case definition','70¬∞F ¬∑ calm ¬∑ solo ¬∑ 42PSI ¬∑ cruise ¬∑ 100% SOH'],
   ['üèîÔ∏è Altitude model','ISA std atmosphere rho*(1-2.2558e-5*h)^5.2559'],
   ['‚ö†Ô∏è Disclaimer','Cd=0.31 estimated from EPA data (not published by GM) ¬∑ Educational estimates only ¬∑ Not affiliated with GM'],
   ['üîã SOH effect','Range (kWh) + small Ri loss: 80% SOH ‚âà 2% extra battery loss'],
   ['üõû Load Crr scaling','+0.00004 per 100kg over base mass (tire deformation)'],
   ['üî• Heat pump COP','Linear interp: 1.0@0¬∞F ‚Üí 1.55@20¬∞F ‚Üí 2.0@30¬∞F ‚Üí 2.5@45¬∞F ‚Üí 3.0@60¬∞F+'],
  ].forEach(function(r){
    var d=el('div',{class:'mini',style:{display:'flex',justifyContent:'space-between',gap:'6px',marginBottom:'0'}});
    d.appendChild(el('span',{style:{fontSize:'10px',color:'#64748b'}},r[0]));
    d.appendChild(el('span',{class:'mono',style:{fontSize:'10px',color:'#e2e8f0',fontWeight:'600',textAlign:'right'}},r[1]));
    pg.appendChild(d);
  });
  card.appendChild(pg);
  card.appendChild(el('div',{style:{fontSize:'10px',color:'#64748b',fontWeight:'700',marginBottom:'4px',textTransform:'uppercase',letterSpacing:'.06em'}},'üìê Core Equations'));
  card.appendChild(el('pre',null,
    '-- Traction --\nP_aero  = 0.5 * rho(T,alt) * Cd * A * (v + v_wind)¬≥\nP_roll  = Crr(PSI,AWD) * m * g * v\nP_grade = m * g * sin(arctan(grade/100)) * v\nP_tract = (P_aero + P_roll + P_grade) / eta_drivetrain\n\n-- HVAC (traffic-mode scaled) --\nHEATING: P_hvac = UA_eff * dT / COP_hp(T_amb) * (v / v_avg)\nCOOLING: P_hvac = (UA_eff*|dT| + P_solar + P_occ) * 0.55 / COP_ac * (v / v_avg)\n\n-- Battery draw --\nP_batt = (P_tract + P_hvac + P_accessories) / eta_bat(T_amb)\n\n-- Efficiency --\neff = v_mph / P_batt_kW    [mi/kWh]\n\n-- Ghost bar base case --\nBase: 70¬∞F ambient, 72¬∞F cabin, 0 wind, 0 grade, 1 pax,\n      0 cargo, 42 PSI, cruise, no solar, sea level, 100% SOH'));
  tabContent.appendChild(card);
}

// ================================================================
// ANALYTICS ‚Äî fire and forget, never blocks UI
// ================================================================
function track(event, value) {
  try {
    fetch('/.netlify/functions/track', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({event: event, value: String(value), page: 'blazer_calculator'})
    }).catch(function(){});
  } catch(e) {}
}

buildApp();
</script>
</body>
</html>